(function(){xenMCE.Overlay={create:function(n,t,i){xenMCE.Overlay._Tools.loadOverlay(n,t,i)},getParams:function(){return xenMCE.Overlay._get("params")},getInputs:function(){return xenMCE.Overlay._get("inputs")},getOverlay:function(){return xenMCE.Overlay._get("$overlay")},getEditor:function(){return xenMCE.Overlay._get("editor")},getSelection:function(){return xenMCE.Overlay._get("selection")},_get:function(n){var t=xenMCE.Tools.backupOverlay;return typeof t[n]!="undefined"?t[n]:!1}};xenMCE.Templates={};tinymce.create("xenMCE.Tools",{Tools:function(n){var t=this,r=this.static,i="undefined";typeof n=="undefined"&&(n=tinymce.activeEditor);n.on("init",function(){$(n.getElement()).data("mce4",!0)});this.$textarea=$(n.getElement());this.isOldXen=t.getParam("oldXen");this.getEditor=function(){return n};this.isFullscreen=function(){return typeof n.plugins.fullscreen===i?!1:n.plugins.fullscreen.isFullscreen()};xenMCE.Overlay._Tools=this;typeof xenMCE.Plugins.Auto!==i&&$.each(xenMCE.Plugins.Auto,function(n,i){new i(t)})},overlayParams:{},overlayInputs:{},loadOverlay:function(n,t,i){var u=this,c=this.getEditor(),l=c.dom,o=isLink=isEmail=!1,s=url_href="",r=c.selection,h,f,v=f?0:1,a=xenMCE.Tools.backupOverlay,e;selElm=r.getNode();anchorElm=l.getParent(selElm,"a[href]");anchorElm&&(o=!0,r.select(anchorElm),s=r.getContent({format:"text"}),url_href=anchorElm?l.getAttrib(anchorElm,"href"):"",isEmail=url_href.indexOf("mailto")==0&&url_href.indexOf("@")>0&&url_href.indexOf("//")==-1?!0:!1,isLink=!isEmail);e=ed.settings.xen_attach.split(",");xenAttach={type:e[0],id:e[1],hash:e[2]};h=r.getContent();f=r.getContent({format:"text"});a.selection={sel:r,text:f,html:h,isUrl:o,isLink:isLink,isEmail:isEmail,url:{text:s,href:url_href,anchorElm:anchorElm}};typeof t!="object"&&(t={});this.overlayParams={dialog:n,src:u.isDefined(i,"src"),onbeforeload:u.isDefined(i,"onbeforeload"),onafterload:u.isDefined(i,"onafterload"),onsubmit:u.isDefined(i,"onsubmit"),wmConfig:t};XenForo.ajax("index.php?editor/quattro-dialog",{dialog:n,selectedHtml:h,selectedText:f,isUrl:o,isLink:isLink,isEmail:isEmail,urlDatas:{text:s,href:url_href},attach:xenAttach},$.proxy(this,"_overlayLoader"))},_overlayLoader:function(n){if(!XenForo.hasResponseError(n)&&typeof n.templateHtml!="undefined"){var r=this,u=this.getEditor(),i=this.overlayParams,t=i.wmConfig,e='<div><div class="mce-xen-body">'+n.templateHtml+"<\/div><\/div>",f={};new XenForo.ExtLoader(n,function(){function a(n){return $inputs=n.find(k.toString()),$inputs.length>0&&$inputs.each(function(){var n=$(this).attr("name");n&&(f[n]=$(this).val())}),n.find("*").filter(function(){$(this).data("value")&&(f[$(this).attr("name")]={html:$(this).html(),text:$(this).text(),data:$(this).data("value")});parseInt($(this).data("hide"))==1&&$(this).hide()}),r.overlayInputs=f,l.inputs=f,f}var o="undefined",s=u.windowManager,c=xenMCE.Phrases,w=c.insert,b=c.cancel,k=["input","textarea","select"],l=xenMCE.Tools.backupOverlay,v,y,d,p,n,h;return l.params=i,l.editor=u,$html=$(e),$title=$html.find(".mceTitle").remove(),$Submit=$html.find(".mceSubmit").remove(),$Cancel=$html.find(".mceCancel").remove(),$Submit.length==1&&(w=r.getTagName($Submit,!0)),$Cancel.length==1&&(b=r.getTagName($Cancel,!0)),a($html),$title&&(t.title=$title.text()),typeof t.title!==o&&t.title||(t.title=c.notitle),v=r.getParam("overlayDefaultSize"),typeof t.width===o&&(t.width=v.w),typeof t.height===o&&(t.height=v.h),typeof $title.data("width")!==o&&(t.width=parseInt($title.data("width"))),typeof $title.data("height")!==o&&(t.height=parseInt($title.data("height"))),typeof t.data!==o?($.each(t.data,function(n,t){$e=$html.find("[name="+n+"]");$e.length==1&&(r.getTagName($e,k)?$('<span class="tmp-data-mce">'+t+"<\/span>").insertAfter($e).hide():$e.html(t))}),$.extend(t.data,f)):t.data=f,typeof t.onsubmit!==o&&(originalSubmit=t.onsubmit,t.onsubmit=function(n){var t=$(u.windowManager.windows[0].getEl());xenDatas=a(t);$.extend(n.data,xenDatas);originalSubmit(n,t,u,r)}),typeof t.buttons===o&&(t.buttons=[{text:w,subtype:"primary xenSubmit",minWidth:80,onclick:function(n){var t=u.windowManager.windows[0],f;$overlay=$(t.getEl());i.onsubmit!=!1&&(f=a($overlay),$.extend(n.data,f),i.src[i.onsubmit](n,$overlay,u,r));typeof t.find("form")[0]!="undefined"?t.find("form")[0].submit():t.submit();t.close()}},{text:b,subtype:"xenCancel",onclick:function(){var n=u.windowManager.windows[0];n.close()}}]),t.html=$html.html(),i.onbeforeload!=!1&&(y=i.src[i.onbeforeload](t,r),typeof y!==o&&(t=y)),s.open(t),$overlay=$(s.windows[0].getEl()),xenMCE.Tools.backupOverlay.$overlay=$overlay,d=$overlay.find(".mce-xen-body").height(),s.windows[0].addClass(i.dialog),$overlay.find(".mceFocus").focus(),$overlay.find(".tmp-data-mce").each(function(){$e=$(this);$e.prev().val($e.html());$e.remove()}),$tabs=$overlay.find(".mceTabs").addClass("mce-tabs"),$tabs=r.cleanWhiteSpace($tabs),$panes=$tabs.next(".mcePanes").children().addClass("mce-pane"),$tabs.length>0&&$panes.length>0&&($tabs.children().addClass("mce-tab"),p=$tabs.find(".mceActive").index(),$tabs.tabs($panes,{current:"mce-active",initialIndex:p>=0?p:0})),n="mceSlides",$slides=$overlay.find("."+n),$slides.length>0&&(h=d-40,$slides.height(h).children().height(h),$slider_tabs=$overlay.find("."+n+"Tabs"),$('<a class="'+n+"Navig "+n+'Backward">&lsaquo;<\/a><a class="'+n+"Navig "+n+'Forward">&rsaquo;<\/a>').insertBefore($slides),$overlay.find("."+n+"Navig").css("top",h/2-10+"px"),$slider_tabs.tabs($slides.children(),{effect:"fade",fadeOutSpeed:"fast",rotate:!0}).slideshow({prev:"."+n+"Backward",next:"."+n+"Forward",clickable:!1})),$multi=$overlay.find("textarea, .mce-multiline"),$multi&&(s.windows[0].off("keydown"),$multi.attr("spellcheck","false").attr("hidefocus","true")),$checkBox=$overlay.find(".xenCheckBox"),$checkBox.length>1&&($checkBox.each(function(){var t=$(this).data("phrase"),i=$(this).data("inputname"),n=$(this).data("checked")=="checked"?1:0,r='<i class="mce-ico mce-i-checkbox"><\/i><span>'+t+'<\/span><input name="'+i+'" type="hidden" value="'+n+'" />';n&&$(this).addClass("mce-checked");$(r).prependTo($(this))}),r._initCheckBox($checkBox)),i.onafterload!=!1&&i.src[i.onafterload]($overlay,f,u,r),!1})}},_initCheckBox:function(n){n.children("i").unbind("click").bind("click",function(){$parent=$(this).parent();$input=$(this).siblings("input");var t=parseInt($input.val()),n="mce-checked";t?($parent.removeClass(n),$input.val(0)):($parent.addClass(n),$input.val(1))})},isDefined:function(n,t){var i="undefined";return typeof t===i?typeof n===i?!1:n:typeof n===i||typeof n[t]===i?!1:n[t]},getTagName:function(n,t,i){var r=n.get(0).tagName.toLowerCase(),u;return typeof i=="undefined"&&typeof t=="undefined"?r:(typeof t!="undefined"&&typeof t!="boolean"&&(i=t),t===!0)?(inputs=["input","textarea","select"],$.inArray(r,inputs)!==-1?n.val():n.text()):typeof i=="object"?(u=[],$.each(i,function(n,t){u.push(t.toLowerCase())}),$.inArray(r,u)!=-1?!0:!1):r==i.toLowerCase()?!0:!1},cleanWhiteSpace:function(n){return n.contents().filter(function(){return this.nodeType==3&&!/\S/.test(this.nodeValue)}).remove(),n},isActiveButton:function(n){for(var t=[],i=1;typeof ed.settings["toolbar"+i]!="undefined";i++)t=t.concat(ed.settings["toolbar"+i].split(" "));return tinymce.inArray(t,n)==-1?!1:!0},getButtonByName:function(n,t){var r=this.getEditor(),u=r.buttons,s=r.theme.panel.find("toolbar *"),f="undefined";if(typeof u[n]===f)return!1;var e=u[n],i=!1,o=0;return tinymce.each(e,function(){o++}),tinymce.each(s,function(n){if(n.type=="button"&&typeof n.settings!==f){var r=0;if(tinymce.each(n.settings,function(n,t){e[t]==n&&r++}),r==o)return i=n,t!=!1&&(i=n.getEl()),!1}}),i},getPathEl:function(n){var r=this.getEditor(),u=r.theme.panel&&r.theme.panel.find("#statusbar")[0],t,i;return u&&(t=u.find(".path"),typeof t[0]!="undefined")?(i=t[0].getEl(),n==!0?$(i):i):!1},getButtonsByProperty:function(n,t,i){var s=this.getEditor(),h=s.theme.panel.find("toolbar *"),u="undefined",r={},f;if(tinymce.each(h,function(i,f){var e=i.settings;i.type=="button"&&typeof e!==u&&(typeof t!==u&&typeof e[n]!==u&&e[n]==t?r[f]=i:(typeof t===u||t===null)&&typeof e[n]!==u&&(r[f]=i))}),typeof i!==u&&(f=$(),$.each(r,function(n,t){f=f.add($(t.getEl()))}),r=f),typeof i=="object"&&i instanceof jQuery){var c=i,e=[],o="_tmp_";$.each(r,function(n,t){e.push("#"+$(t).attr("id"))});e=e.toString();r=c.find(e).addClass(o).find(">:first-child").parents("."+o).removeClass(o)}return r},buildMenuItems:function(n,t,i,r){var e=[],o=[],u="undefined",f;return typeof t===u&&(t=n),tinymce.each(t.split(/\|/),function(n){o.push(n)}),tinymce.each(n.split(/\|/),function(n,t){if(f=typeof o[t]!==u?o[t]:"",typeof i===u||i==null)return e.push({text:n,value:f});var s={title:n,text:n,value:f,textStyle:i.replace(/{t}/g,n).replace(/{v}/g,f)};typeof r!==u&&(s.classes=r);e.push(s)}),e},createListBoxChangeHandler:function(n,t){return ed=this.getEditor(),function(){var i=this;ed.on("nodeChange",function(r){var f=ed.formatter,u=null;tinymce.each(r.parents,function(i){return tinymce.each(n,function(n){return t?f.matchNode(i,t,{value:n.value})&&(u=n.value):f.matchNode(i,n.value)&&(u=n.value),u?!1:void 0}),u?!1:void 0});i.value(u)})}},insertBbCode:function(n,t,i){n=n.replace(/^at_/,"");var r=this.getEditor(),f=r.dom,u="MceCaretBb",e="["+n,o="[/"+n+"]";i||(i=r.selection.getContent());i+='<span id="'+u+'"><\/span>';e+=t?"="+t+"]":"]";r.execCommand("mceInsertContent",!1,e+i+o);r.selection.select(f.get(u));f.remove(u)},getParam:function(n){return typeof xenMCE.Params[n]!="undefined"?xenMCE.Params[n]:null},unescapeHtml:function(n,t){n=n.replace(/&amp;/g,"&").replace(/&lt;/g,"<").replace(/&gt;/g,">").replace(/&quot;/g,'"').replace(/&#039;/g,"'");t=="noBlank"&&(n=n.replace(/	/g,"\t").replace(/&nbsp;/g,"  ").replace(/<\/p>\n<p>/g,"\n"));var i=new RegExp("^<p>([\\s\\S]+)<\/p>$","i");return i.test(n)&&(n=n.match(i),n=n[1]),n},escapeHtml:function(n,t){return t!=="onlyBlank"&&(n=n.replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;").replace(/"/g,"&quot;").replace(/'/g,"&#039;")),t!=="noBlank"&&(n=n.replace(/\t/g,"\t").replace(/ /g,"&nbsp;").replace(/\n/g,"<\/p>\n<p>")),n},getSelection:function(){return xenMCE.Overlay._get("selection")},zen2han:function(n){for(var t,r="",i=0,u=n.length;i<u;i++)t=n.charCodeAt(i),t=t>=65281&&t<=65392?t-65248:t,t=t===12540?45:t,r=r+String.fromCharCode(t);return r},static:{backupOverlay:{}}});tinymce.PluginManager.add("xenforo",xenMCE.Tools);var n="xenMCE.Plugins.Auto";tinymce.create(n+".BbmButtons",{BbmButtons:function(n){$.extend(this,n);this.ed=this.getEditor();var i=this.ed,t=this,r=t.getParam("bbmButtons"),u="undefined";$.each(r,function(n,r){var f=r.code;if(config={name:f,tooltip:r.desc},r.type=="manual"?(config.icon=f,r.typeOpt&&(config.classes=r.typeOpt)):r.type=="text"?(config.icon=!1,config.text=r.typeOpt):(config.icon=f,config.iconset=r.iconSet),r._return=="direct"?config.onclick=function(){t.insertBbCode(n,r.tagOpt,r.tagCont)}:r._return!="kill"&&(config.onclick=function(){var i,u;t.bbm_tag=n;t.bbm_separator=r.separator;i={onsubmit:t.submit};u={src:t,onafterload:"onafterload"};t.loadOverlay("bbm_"+r.template,i,u)}),r._return=="kill"){if(typeof i.buttons[r.code]===u){console.debug('Button "'+r.code+'" not found - Dev: activate your plugin before xenforo plugin / Admin: Delete it from the BBM');return}$.extend(i.buttons[r.code],config);return}t.ed.addButton(f,config)})},onafterload:function(n,t,i,r){var u=r.overlayParams.dialog.replace("bbm_","Bbm_"),f="undefined";if(typeof xenMCE.Templates[u]!==f&&typeof xenMCE.Templates[u].onafterload!==f)xenMCE.Templates[u].onafterload(n,t,i,r)},submit:function(n,t,i,r){var u=r.overlayParams.dialog.replace("bbm_","Bbm_"),f="undefined";typeof xenMCE.Templates[u]!==f&&typeof xenMCE.Templates[u].submit!==f&&xenMCE.Templates[u].submit(n,t,i,r)}});tinymce.create(n+".XenSwitch",{XenSwitch:function(n){$.extend(this,n);this.ed=this.getEditor();var t="xen_switch";this.ed.addButton(t,{name:t,icon:t,iconset:"xenforo",xenfright:!0,tooltip:xenMCE.Phrases.switch_text[0],onclick:$.proxy(this,"wysiwygToBbCode")})},wysiwygToBbCode:function(){var n,t,i;this.isFullscreen()==!0&&(n=this.getButtonByName("fullscreen"),n!=!1&&$(n).trigger("click"));t={content:this.ed.getContent()};this.ed.fire("XenSwitchToBbCode",t);i=t.content;XenForo.ajax("index.php?editor/to-bb-code",{html:i},$.proxy(this,"wysiwygToBbCodeSuccess"))},wysiwygToBbCodeSuccess:function(n){if(!XenForo.hasResponseError(n)&&typeof n.bbCode!="undefined"&&(typeof n.isConnected=="undefined"||n.isConnected||this.ed.windowManager.alert(n.notConnectedMessage),$container=$(this.ed.getContainer()),$existingTextArea=$(this.ed.getElement()),$textContainer=$('<div class="bbCodeEditorContainer" />'),$newTextArea=$('<textarea class="textCtrl Elastic" rows="5" />'),!$existingTextArea.attr("disabled"))){var t=$existingTextArea.attr("name").replace(/_html(]|$)/,"");$newTextArea.attr("id",t).attr("name",t).val(n.bbCode).appendTo($textContainer);$("<a />").attr("href","javascript:").text(xenMCE.Phrases.switch_text[1]).click($.proxy(this,"bbCodeToWysiwyg")).appendTo($("<div />").appendTo($textContainer));$existingTextArea.attr("disabled",!0);$container.after($textContainer).hide();$textContainer.xfActivate();$newTextArea.focus();this.$bbCodeTextContainer=$textContainer;this.$bbCodeTextArea=$newTextArea}},bbCodeToWysiwyg:function(){XenForo.ajax("index.php?editor/to-html",{bbCode:this.$bbCodeTextArea.val()},$.proxy(this,"bbCodeToWysiwygSuccess"))},bbCodeToWysiwygSuccess:function(n){var t,i;XenForo.hasResponseError(n)||typeof n.html=="undefined"||(typeof n.isConnected=="undefined"||n.isConnected||this.ed.windowManager.alert(n.notConnectedMessage),$container=$(this.ed.getContainer()),$existingTextArea=$(this.ed.getElement()),$existingTextArea.attr("disabled"))&&($existingTextArea.attr("disabled",!1),$container.show(),t={content:n.html},this.ed.fire("XenSwitchToWysiwyg",t),i=t.content,this.ed.setContent(i),this.ed.focus(),this.$bbCodeTextContainer.remove())}});tinymce.create(n+".XenIcons",{XenIcons:function(n){var t=n.getEditor(),r=xenMCE.Phrases,i="undefined";t.on("BeforeRenderUI",function(){function u(n){typeof t.menuItems[n]!==i&&delete t.menuItems[n]}function f(n){typeof t.buttons[n].type!==i&&delete t.buttons[n].type}if(n.isActiveButton("xen_link")||u("xen_link"),!n.isActiveButton("table"))tinymce.each(["inserttable","xen_tableskin","cell","row","column","deletetable"],function(n){u(n)});tinymce.each(t.buttons,function(n,u){var f=u+"_desc";XenForo.isTouchBrowser()?typeof t.buttons[u].tooltip!==i&&delete t.buttons[u].tooltip:typeof r[f]!==i&&(t.buttons[u].tooltip=r[f])});n.getParam("extraLists")!=!0&&(f("bullist"),f("numlist"))});t.on("init",function(){$buttons=n.getButtonsByProperty("iconset","xenforo",!0);$buttons.find("i.mce-ico").addClass("mce-xenforo-icons");var i=t.theme.panel.find("#statusbar");i&&i.length>0&&($statBar=$(i[0].getEl()));n.getParam("hidePath")&&i.length>0&&$statBar.find(".mce-path").css("visibility","hidden")})}});tinymce.create(n+".XenFonts",{XenFonts:function(n){for(var t=n.getEditor(),v=tinymce.ui.Factory,f,r,a="undefined",s="xen-font-size",h="font-family",c="xen-"+h,e=xenMCE.Phrases,o="",u,l=n.isOldXen===!0?"xx-small|x-small|small|medium|large|x-large|xx-large":"9px|10px|12px|15px|18px|22px|26px",i=1;i<8;i++)o+=e.size+" "+i,i!=7&&(o+="|");f=n.buildMenuItems(o,l,"font-size:{v}",s);t.addButton("xen_fontsize",{name:"xen_fontsize",type:"listbox",values:f,icon:!1,fixedWidth:!0,text:e.font_size,onPostRender:n.createListBoxChangeHandler(f,"fontsize"),onShow:function(n){n.control.addClass(s+"-menu");n.control.initLayoutRect()},onclick:function(n){n.control.settings.value&&t.execCommand("FontSize",!1,n.control.settings.value)}});r=n.buildMenuItems("Andale Mono|Arial|Arial Black|Book Antiqua|Courier New|Georgia|Helvetica|Impact|Tahoma|Times New Roman|Trebuchet MS|Verdana","andale mono,times|arial,helvetica,sans-serif|arial black,avant garde|book antiqua,palatino|courier new,courier|georgia,palatino|helvetica|impact,chicago|tahoma,arial,helvetica,sans-serif|times new roman,times|trebuchet ms,geneva|verdana,geneva",h+":{v}",c);t.addButton("xen_fontfamily",{name:"xen_fontfamily",type:"listbox",values:r,icon:!1,fixedWidth:!0,text:e.font_family,onPostRender:n.createListBoxChangeHandler(r,"fontname"),onShow:function(n){n.control.addClass(c+"-menu");n.control.initLayoutRect()},onclick:function(n){n.control.settings.value&&t.execCommand("FontName",!1,n.control.settings.value)}});u={};$.each(r,function(n,t){u[t.title.toLowerCase()]=t.value});t.on("preInit",function(){t.on("PreProcess SetContent",function(n){var i=t.dom;tinymce.each(i.select("span",n.node),function(n){var t=n.style.fontFamily;t&&(t=t.toLowerCase().replace(/'/g,""),t!=="serif"&&typeof u[t]!==a&&i.setStyle(n,"fontFamily",u[t]))})})})}});tinymce.create(n+".Fright",{Fright:function(n){if(n.getParam("frightMode")!=!0)return!1;$.extend(this,n);var u=this,f=this.getEditor(),r="mce-top-right-body",t="mce-first",i="mce-last";f.on("postrender",function(n){if($toolbar=$(n.target.contentAreaContainer).prev(),$firstLine=$toolbar.find(".mce-toolbar").first(),$buttons=u.getButtonsByProperty("xenfright",null,$toolbar),!$buttons.length>0)return!1;$buttons.each(function(n){$e=$(this);n++;$e.hasClass(t)&&$e.removeClass(t).next().addClass(t);$e.hasClass(i)&&$e.removeClass(i).prev().addClass(i);n==1&&$e.addClass(t);n==$buttons.length&&$e.addClass(i)});$fl=$('<div id="mce-top-right" class="mce-container mce-flow-layout-item mce-btn-group" role="toolbar" />');$fl_body=$('<div id="'+r+'" />').append($buttons);$fl_body.prependTo($fl);$fl.prependTo($firstLine)}).on("FullscreenStateChanged",function(){$("#"+r+":first-child").addClass(t);$("#"+r+":last-child").addClass(i)})}});tinymce.create(n+".quirks",{quirks:function(n){var t=n.getEditor(),r="InlineMessageEditor",i;t.on("postrender",function(n){$container=$(t.getContainer());$container.parents("form").hasClass(r)&&tinyMCE.activeEditor.execCommand("mceAutoResize",!1,n)});t.on("BeforeSetContent",function(i){function u(n){return/^(?:[\s]+)?<img[^>]*?\/>(?:[\s]+)?$/.test(n)}function f(n){var t=/(class="[^"]+?(?="))/;return t.test(n)?n.replace(t,"$1 "+r):n.replace(/(<img)/,'$1 class="'+r+'" ')}if(n.getParam("extendInsert")){var r="tmp_"+(new Date).getTime().toString(16);u(i.content)&&(i.content=f(i.content));t.on("ExecCommand",function(n){var h=n.command,s;if(h=="mceInsertContent"){var f=t.selection.getBookmark(),i=$(t.getBody()),e=i.find("#"+f.id+"_start"),c=e.offset().top,o=i.parent().add(i);if(t.selection.moveToBookmark(f),e.length)if(s=n.value,u(s))i.find("img."+r).one("load",function(n){t.execCommand("mceAutoResize",!1,n);var i=$(this),u=i.offset(),f=u.top+i.height();i.removeClass(r);o.scrollTop(f)});else o.scrollTop(c),t.execCommand("mceAutoResize",!1,n)}})}});if(!n.isOldXen)return!1;t.on("postrender",function(){var n=t.getDoc();if($form=$(t.getContainer()).parents("form"),!tinymce.isIE&&$form.hasClass(r))try{t.settings.readonly||(n.designMode="On")}catch(i){}});n.getParam("geckoFullfix")&&(i=XenForo._overlayConfig.onBeforeLoad,XenForo._overlayConfig.onBeforeLoad=function(n){if(window.tinyMCE&&tinymce.isGecko&&$(this.getTrigger()).hasClass("edit")&&($mceTextarea=$(tinyMCE.activeEditor.getElement()),!$mceTextarea.attr("disabled"))){var t=$mceTextarea.attr("id");tinyMCE.execCommand("mceRemoveEditor",!1,t);tinyMCE.execCommand("mceAddEditor",!0,t);tinyMCE.activeEditor.focus()}typeof i=="function"&&i(n)})}});tinymce.create(n+".TableIntegration",{TableIntegration:function(n){function i(n,i){var f=t.dom,u;(u=t.dom.getParent(t.selection.getStart(),"table"),typeof u!=r)&&($tableElm=$(u),$tableElm.attr("data-skin","skin"+i))}function u(n){var f=t.dom,u,i;if((u=t.dom.getParent(t.selection.getStart(),"table"),$skins=$(n.control.getEl()).find(".mce-text"),$skins.css("font-weight","normal"),typeof u!=r)&&($tableElm=$(u),i=$tableElm.attr("data-skin"),typeof i!=r)){if(i=parseInt(i.replace("skin","")),isNaN(i)||i>4)return!1;$skins.eq(i-1).css("font-weight","bold")}}this.ed=n.getEditor();var f=this,t=this.ed,r="undefined";t.addMenuItem("xen_tableskin",{name:"xen_tableskin",text:"Table skins",context:"table",onShow:u,menu:[{text:"Skin 1",onclick:function(n){i(n,1)}},{text:"Skin 2",onclick:function(n){i(n,2)}},{text:"Skin 3",onclick:function(n){i(n,3)}},{text:"Skin 4",onclick:function(n){i(n,4)}}]})}});tinymce.create(n+".Fullscreen",{Fullscreen:function(n){var t=n.getEditor(),i;if(typeof t.buttons.fullscreen=="undefined")return!1;if(i=t.buttons.fullscreen,tinymce.isIE&&tinymce.Env.ie<=7)return delete t.buttons.fullscreen,!1;i.xenfright=!0;t.on("FullscreenStateChanged",function(n){$container=$(t.getContainer());$(n.target.contentDocument).find("html").css("overflow","auto");n.state==!1&&($("html, body").animate({scrollTop:$container.offset().top},300),t.focus())})}});tinymce.create(n+".XenLink",{XenLink:function(n){$.extend(this,n);this.ed=this.getEditor();var u=this,t=this.ed,i={},r={};i={name:"xen_link",icon:"link",shortcut:"Ctrl+K",stateSelector:"a[href]",onclick:$.proxy(this,"init")};r={type:"splitbutton",menu:u.buildMenuItems(xenMCE.Phrases.unlink),onshow:function(){$(".mce-tooltip:visible").hide()},onselect:function(){t.execCommand("unlink")}};n.getParam("fastUnlink")&&$.extend(i,r);t.addButton("xen_link",i);t.addButton("xen_unlink",{name:"xen_unlink",icon:"unlink",cmd:"unlink",stateSelector:"a[href]"});t.addMenuItem("xen_link",{name:"xen_link",icon:"link",shortcut:"Ctrl+K",stateSelector:"a[href]",onclick:$.proxy(this,"init"),text:xenMCE.Phrases.xen_link_desc,context:"insert",prependToContext:!0})},init:function(){var n=this.getParam("overlayLinkSize");config={width:n.w,height:n.h,onsubmit:this.submit};this.loadOverlay("link",config)},submit:function(n,t,i,r){xenMCE.Templates.Link.submit(n,t,i,r)}});tinymce.create(n+".XenColors",{XenColors:function(n){function r(t){var r=t.panel.html,u=t.selectcmd,f=t.onclick;n.getParam("extraColors")==!0&&(t.panel.html=function(){var n='<div href="#" class="mceAdvPicker" data-mode="'+u+'">';return n+=xenMCE.Phrases.more_colors,n+="<\/div>",r()+n});t.onshow=function(){var t=this,n,r;$(".mceAdvPicker").unbind("click").bind("click",function(n){n.preventDefault();t.hidePanel();var r={mode:$(this).data("mode"),buttonCtrl:t};i.init(r)});$button=$(this.getEl());$panel=$(this.panel.getEl());n=$button.offset();r=$button.position();n.top=i.isFullscreen()?r.top+$button.height()+parseInt($panel.css("marginTop")):n.top+$button.height()+parseInt($panel.css("marginTop"));$panel.offset(n)}}$.extend(this,n);var i=this,t=this.ed=this.getEditor();typeof t.buttons.forecolor!="undefined"&&r(t.buttons.forecolor);typeof t.buttons.backcolor!="undefined"&&r(t.buttons.backcolor)},init:function(n){this._colorButton=n;var t=this.getParam("overlayColorPickerSize");config={width:t.w,height:t.h,onsubmit:$.proxy(this,"submit")};callbacks={src:this,onafterload:"onafterload"};this.loadOverlay("colors",config,callbacks)},onafterload:function(n,t,i,r){xenMCE.Templates.ColorPicker.init(n,t,i,r)},submit:function(n,t,i,r){r=this;xenMCE.Templates.ColorPicker.submit(n,t,i,r)}});tinymce.create(n+".XenMedia",{XenMedia:function(n){$.extend(this,n);this.ed=this.getEditor();var i=this,t=this.ed;t.addButton("xen_media",{name:"xen_media",icon:"media",onclick:$.proxy(this,"init")})},init:function(){var n=this.getParam("overlayMediaSize");config={width:n.w,height:n.h,onsubmit:this.submit};this.loadOverlay("media",config)},submit:function(n,t,i,r){xenMCE.Templates.Media.submit(n,t,i,r)}});tinymce.create(n+".XenImage",{XenImage:function(n){$.extend(this,n);this.ed=this.getEditor();var i=this,t=this.ed;t.addButton("xen_image",{name:"xen_image",icon:"image",stateSelector:"img:not([data-mce-object],[data-smilie])",onclick:$.proxy(this,"init")})},init:function(){var n=this.ed.selection.getNode(),t=this.getParam("overlayImageSize");config={width:t.w,height:t.h,onsubmit:this.submit};n.nodeName=="IMG"&&(config.data={url:this.ed.dom.getAttrib(n,"src")});this.loadOverlay("image",config)},submit:function(n,t,i,r){xenMCE.Templates.Image.submit(n,t,i,r)}});tinymce.create(n+".XenCode",{XenCode:function(n){$.extend(this,n);this.ed=this.getEditor();var r=this,i=this.ed,t="xen_code";i.addButton(t,{name:t,icon:t,iconset:"xenforo",onclick:$.proxy(this,"init")})},init:function(){config={width:480,height:300,onsubmit:this.submit};this.loadOverlay("code",config)},submit:function(n,t,i,r){xenMCE.Templates.Code.submit(n,t,i,r)}});tinymce.create(n+".XenQuote",{XenQuote:function(n){var i=n.getEditor(),t="xen_quote";i.addButton(t,{name:t,icon:t,iconset:"xenforo",onclick:function(){n.insertBbCode("quote",!1)}})}});tinymce.create(n+".XenSmilies",{XenSmilies:function(n){function f(i){function o(i,r){return tinymce.each(r,function(r,e){var s=t.dom,o={id:r[1],desc:r[0],bbcode:s.encode(e)},l=n.getParam("smiliesDesc");if(l=="bbcode"?o.desc=e:l=="none"&&(o.desc=""),u!=0&&c>u)return!1;i+=typeof o.id=="number"?'<a href="#"><img src="styles/default/xenforo/clear.png" alt="'+o.bbcode+'" title="'+o.desc+'" '+h+' class="'+f+" "+f+"Sprite mceSmilie"+o.id+'"  /><\/a>':'<a href="#"><img src="'+s.encode(o.id)+'" alt="'+o.bbcode+'" title="'+o.desc+'" '+h+' class="'+f+'" /><\/a>';c++}),i}var c=1,u,f="mceQuattroSmilie",l="",e=n.getParam("xenforo_smilies"),a=n.getParam("smiliesCat"),s=n.getParam("xCatSmilies"),r,h;return i===!0?(u=0,l="Full"):u=n.getParam("xSmilies"),r='<div role="presentation" class="'+f+"Block"+l+'">',h='data-smilie="yes"',a?i!==!0&&s!=-1&&typeof e[s]!="undefined"?r+=o("",e[s].smilies):tinymce.each(e,function(n){i===!0?(r+='<p class="mce_smilie_cat_title">'+n.title+"<\/p>",r+='<div class="mce_smilie_cat">'+o("",n.smilies)+"<\/div>"):r+=o("",n.smilies)}):r=o(r,e),r+="<\/div>"}function e(){return f()}function o(){var n=f(!0),i={type:"container",html:n,onclick:function(n){var i,r;n.preventDefault();i=t.dom.getParent(n.target,"a");i&&(r=$(i).html(),t.execCommand("mceInsertContent",!1,r))}},r=t.windowManager.open({title:"Smilies picker",spacing:10,padding:10,items:[i],buttons:[{text:"Close",onclick:function(){r.close()}}]})}var r;$.extend(this,n);var s=this,t=this.getEditor(),u="xen_smilies",i="xen_smilies_picker";t.addButton(u,{name:u,icon:"emoticons",type:"panelbutton",stateSelector:"img[data-smilie]",popoverAlign:"bc-tl",panel:{autohide:!0,html:e,onclick:function(n){var i=t.dom.getParent(n.target,"a"),r;i&&(r=$(i).html(),t.execCommand("mceInsertContent",!1,r),this.hide())}}});r={name:i,icon:i,iconset:"xenforo",tooltip:"Smilies picker",stateSelector:"img[data-smilie]"};r.onclick=n.getParam("smiliesSlider")==!0?$.proxy(this,"init"):o;t.addButton(i,r)},init:function(){var n=this.getParam("overlaySmiliesSize");config={width:parseInt(n.w),height:parseInt(n.h)};callbacks={src:this,onafterload:"onafterload"};this.loadOverlay("smilies_slider",config,callbacks)},onafterload:function(n,t,i,r){xenMCE.Templates.SmiliesSlider.init(n,t,i,r)}});tinymce.create(n+".XenNonBreaking",{XenNonBreaking:function(n){var t=n.getEditor(),r="xen_nonbreaking",i="XenNonBreaking";if(t.addCommand(i,function(){t.insertContent(t.plugins.visualchars&&t.plugins.visualchars.state?'<span data-mce-bogus="1" class="mce-nbsp">&nbsp;<\/span>':"&nbsp;")}),t.addButton(r,{name:r,cmd:i}),t.getParam("nonbreaking_force_tab"))t.on("keydown",function(n){if(n.keyCode==9){n.preventDefault();for(var r=0;r<4;)t.execCommand(i),r++}})}});tinymce.create(n+".XenDraft",{XenDraft:function(n){var f,e;if(n.isOldXen)return!1;this.ed=n.getEditor();this.draftText=xenMCE.Phrases.draft;this.$textarea=n.$textarea;this.autoSaveUrl=this.$textarea.data("auto-save-url");var t=this,i=this.ed,u="Draft mode: ",r="restoredraft";if(!this.autoSaveUrl||!n.getParam("xendraft")){console.info(u+"Mce");return}console.info(u+"Xen");f=n.buildMenuItems(t.draftText.save+"|"+t.draftText._delete,"saveDraft|deleteDraft",null,"xen_draft");e=function(n){t.saveDraft(!0,n.control.settings.value=="deleteDraft")};i.on("BeforeRenderUI",function(){if(!n.isActiveButton(r))return!1;i.addButton(r,{name:r,title:t.draftText.save,type:"menubutton",menu:f,onselect:e})});i.on("init",function(){t.pathEl=n.getPathEl(!0);t.initAutoSave()});i.addCommand("xenDraftSave",function(){t.saveDraft(!0)});i.addCommand("xenDraftDelete",function(){t.saveDraft(!0,!0)})},initAutoSave:function(){var n=this,i=$(this.ed.getContainer()).parents("form"),r=n.$textarea.data("options"),u=this.ed.getContent(),t;i.length&&(this.lastAutoSaveContent=u,t=setInterval(function(){if(!n.$textarea.data("mce4")){clearInterval(t);return}n.saveDraft()},(r.autoSaveFrequency||60)*1e3))},saveDraft:function(n,t){var i=this,f=$(this.ed.getContainer()).parents("form"),o=this.ed.windowManager,e={content:this.ed.getContent()},u="",r;return(this.ed.fire("SavingXenDraft",e),u=e.content,!t&&!n&&u==this.lastAutoSaveContent)?!1:(this.lastAutoSaveContent=u,r=$.Event("BbCodeWysiwygEditorAutoSave"),r.editor=this,r.content=u,r.deleteDraft=t,f.trigger(r),r.isDefaultPrevented())?!1:this.autoSaveRunning?!1:(this.autoSaveRunning=!0,XenForo.ajax(this.autoSaveUrl,f.serialize()+(t?"&delete_draft=1":""),function(r){var e=$.Event("BbCodeWysiwygEditorAutoSaveComplete"),u;if(e.ajaxData=r,f.trigger(e),!e.isDefaultPrevented()){if(r.draftSaved?u=i.draftText.saved:r.draftDeleted&&(u=i.draftText.deleted),!u)return;if(n||t){o.alert(u);return}if(i.pathEl==!1){console.log(i.draftText.saved);return}$path=i.pathEl;$('<div class="draftNotice"><span>'+u+"<\/span><\/div>").insertAfter($path).css({display:"inline-block",padding:"8px"}).finish().hide().fadeIn().delay(2e3).fadeOut()}},{global:!1}).complete(function(){i.autoSaveRunning=!1}),!0)}})})()