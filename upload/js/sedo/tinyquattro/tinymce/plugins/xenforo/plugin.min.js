(function(n){xenMCE.Overlay={create:function(n,t,i){xenMCE.Overlay._Tools.loadOverlay(n,t,i)},getParams:function(){return xenMCE.Overlay._get("params")},getInputs:function(){return xenMCE.Overlay._get("inputs")},getOverlay:function(){return xenMCE.Overlay._get("$overlay")},getEditor:function(){return xenMCE.Overlay._get("editor")},getSelection:function(){return xenMCE.Overlay._get("selection")},_get:function(t){var i=xenMCE.Tools.backupOverlay;return typeof i[t]!==n?i[t]:!1}},xenMCE.Templates={},tinymce.create("xenMCE.Tools",{Tools:function(t){var i=this,r=this.static;typeof t===n&&(t=tinymce.activeEditor);t.on("init",function(){$(t.getElement()).data("mce4",!0)});this.$textarea=$(t.getElement()),this.isOldXen=i.getParam("oldXen");t.on("init",function(){var r=t.windowManager,u=r.open;r.open=function(i,r){var e,f;return typeof i===n&&(i=!1),typeof r===n&&(r=!1),f={args:i,params:r},t.fire("XenModalInit",f),e=u(i,r),f={modal:e,args:i,params:r},t.fire("XenModalComplete",f),e}});this.getEditor=function(){return t},this.isFullscreen=function(){return typeof t.plugins.fullscreen===n?!1:t.plugins.fullscreen.isFullscreen()},xenMCE.Overlay._Tools=this,typeof xenMCE.Plugins.Auto!==n&&$.each(xenMCE.Plugins.Auto,function(n,t){new t(i)})},overlayParams:{},overlayInputs:{},loadOverlay:function(n,t,i){var e=this,l=this.getEditor(),c=l.dom,o=isLink=isEmail=!1,s=url_href="",r=l.selection,h,f,v=f?0:1,a=xenMCE.Tools.backupOverlay,u;selElm=r.getNode(),anchorElm=c.getParent(selElm,"a[href]"),anchorElm&&(o=!0,r.select(anchorElm),s=r.getContent({format:"text"}),url_href=anchorElm?c.getAttrib(anchorElm,"href"):"",isEmail=url_href.indexOf("mailto")==0&&url_href.indexOf("@")>0&&url_href.indexOf("//")==-1?!0:!1,isLink=!isEmail),u=ed.settings.xen_attach.split(","),xenAttach={type:u[0],id:u[1],hash:u[2]},h=r.getContent(),f=r.getContent({format:"text"}),a.selection={sel:r,text:f,html:h,isUrl:o,isLink:isLink,isEmail:isEmail,url:{text:s,href:url_href,anchorElm:anchorElm}},typeof t!="object"&&(t={}),this.overlayParams={dialog:n,src:e.isDefined(i,"src"),onbeforeload:e.isDefined(i,"onbeforeload"),onafterload:e.isDefined(i,"onafterload"),onsubmit:e.isDefined(i,"onsubmit"),wmConfig:t},XenForo.ajax("index.php?editor/quattro-dialog",{dialog:n,selectedHtml:h,selectedText:f,isUrl:o,isLink:isLink,isEmail:isEmail,urlDatas:{text:s,href:url_href},attach:xenAttach},$.proxy(this,"_overlayLoader"))},_overlayLoader:function(t){if(!XenForo.hasResponseError(t)&&typeof t.templateHtml!="undefined"){var u=this,e=this.getEditor(),r=this.overlayParams,i=r.wmConfig,o='<div><div class="mce-xen-body">'+t.templateHtml+"</div></div>",f={};new XenForo.ExtLoader(t,function(){function w(n){return $inputs=n.find(k.toString()),$inputs.length>0&&$inputs.each(function(){var t=$(this).attr("name");t&&(f[t]=$(this).val())}),n.find("*").filter(function(){$(this).data("value")&&(f[$(this).attr("name")]={html:$(this).html(),text:$(this).text(),data:$(this).data("value")}),parseInt($(this).data("hide"))==1&&$(this).hide()}),u.overlayInputs=f,p.inputs=f,f}var a=e.windowManager,y=xenMCE.Phrases,b=y.insert,d=y.cancel,k=["input","textarea","select"],p=xenMCE.Tools.backupOverlay,c,h,g,l,v,t,s;return p.params=r,p.editor=e,$html=$(o),$title=$html.find(".mceTitle").remove(),$Submit=$html.find(".mceSubmit").remove(),$Cancel=$html.find(".mceCancel").remove(),$Submit.length==1&&(b=u.getTagName($Submit,!0)),$Cancel.length==1&&(d=u.getTagName($Cancel,!0)),w($html),$title&&(i.title=$title.text()),typeof i.title!==n&&i.title||(i.title=y.notitle),c=u.getParam("overlayDefaultSize"),typeof i.width===n&&(i.width=c.w),typeof i.height===n&&(i.height=c.h),typeof $title.data("width")!==n&&(i.width=parseInt($title.data("width"))),typeof $title.data("height")!==n&&(i.height=parseInt($title.data("height"))),typeof i.data!==n?($.each(i.data,function(n,t){$e=$html.find("[name="+n+"]"),$e.length==1&&(u.getTagName($e,k)?$('<span class="tmp-data-mce">'+t+"</span>").insertAfter($e).hide():$e.html(t))}),$.extend(i.data,f)):i.data=f,typeof i.onsubmit!==n&&(originalSubmit=i.onsubmit,i.onsubmit=function(n){var t=$(e.windowManager.windows[0].getEl());xenDatas=w(t),$.extend(n.data,xenDatas),originalSubmit(n,t,e,u)}),typeof i.buttons===n&&(i.buttons=[{text:b,subtype:"primary xenSubmit",minWidth:80,onclick:function(n){var t=e.windowManager.windows[0],i;$overlay=$(t.getEl()),r.onsubmit!=!1&&(i=w($overlay),$.extend(n.data,i),r.src[r.onsubmit](n,$overlay,e,u)),typeof t.find("form")[0]!="undefined"?t.find("form")[0].submit():t.submit(),t.close()}},{text:d,subtype:"xenCancel",onclick:function(){var n=e.windowManager.windows[0];n.close()}}]),i.html=$html.html(),r.onbeforeload!=!1&&(h=r.src[r.onbeforeload](i,u),typeof h!==n&&(i=h)),g=a.open(i,{dialogName:r.dialog,modalClassName:r.dialog,ovlParams:r}),$overlay=$(a.windows[0].getEl()),xenMCE.Tools.backupOverlay.$overlay=$overlay,l=$overlay.children(".mce-container-body").height(),console.log(l),$overlay.find(".mceFocus").focus(),$overlay.find(".tmp-data-mce").each(function(){$e=$(this),$e.prev().val($e.html()),$e.remove()}),$tabs=$overlay.find(".mceTabs").addClass("mce-tabs"),$tabs=u.cleanWhiteSpace($tabs),$panes=$tabs.next(".mcePanes").children().addClass("mce-pane"),$tabs.length>0&&$panes.length>0&&($tabs.children().addClass("mce-tab"),v=$tabs.find(".mceActive").index(),$tabs.tabs($panes,{current:"mce-active",initialIndex:v>=0?v:0})),t="mceSlides",$slides=$overlay.find("."+t),$slides.length>0&&(s=l,$slides.height(s).children().height(s-$slides.data("diff")),$slider_tabs=$overlay.find("."+t+"Tabs"),$('<a class="'+t+"Navig "+t+'Backward">&lsaquo;</a><a class="'+t+"Navig "+t+'Forward">&rsaquo;</a>').insertBefore($slides),$overlay.find("."+t+"Navig").css("top",s/2-10+"px"),$slider_tabs.tabs($slides.children(),{effect:"fade",fadeOutSpeed:"fast",rotate:!0}).slideshow({prev:"."+t+"Backward",next:"."+t+"Forward",clickable:!1})),$multi=$overlay.find("textarea, .mce-multiline"),$multi&&(a.windows[0].off("keydown"),$multi.attr("spellcheck","false").attr("hidefocus","true")),$checkBox=$overlay.find(".xenCheckBox"),$checkBox.length>1&&($checkBox.each(function(){var r=$(this).data("phrase"),u=$(this).data("inputname"),t=$(this).data("checked")=="checked"?1:0,i='<i class="mce-ico mce-i-checkbox"></i><span>'+r+'</span><input name="'+u+'" type="hidden" value="'+t+'" />';t&&$(this).addClass("mce-checked"),$(i).prependTo($(this))}),u._initCheckBox($checkBox)),r.onafterload!=!1&&r.src[r.onafterload]($overlay,f,e,u),!1})}},_initCheckBox:function(n){n.children("i").unbind("click").bind("click",function(){$parent=$(this).parent(),$input=$(this).siblings("input");var i=parseInt($input.val()),t="mce-checked";i?($parent.removeClass(t),$input.val(0)):($parent.addClass(t),$input.val(1))})},responsiveModal:function(n){function r(){var f=($(window).width()-t.width())/2,r=t.find(".mce-xen-body"),h=r.css("overscroll"),l=t.find("mce-foot");if(f<0){f=1,n.addClass(i),t.children().add(r).addClass(i);var o=$(window).width(),e=o-5,s=t.find("*").filter(function(){function t(n){return n.indexOf("%")!=-1?!1:parseInt(n)>=o?($(this).data("owidth")||$(this).data("owidth",n),!0):void 0}var i=$(this).prop("style").width,r=$(this).css("width"),n;return(n=t(i),n==!0)?!0:(n=t(r),$(this).css("width")==$(this).parent().css("width"))?!1:n==!0?!0:!1}),c=t.find("*").filter(function(){var n=$(this).css("white-space");return n!="normal"&&!$(this).data("onw")?($(this).data("onw",n),!0):!1});s.add(t).css({"max-width":e+"px"}),t.find(".responsiveBlock").css({"max-width":e-15+"px"}),t.find(".mainBodyOverflow").length&&u.css("overflow","auto"),t.find(".disableXenBodyOverflow").length==0&&r.data("ovsc",h).css("overflow","auto"),c.css({"white-space":"normal"})}t.css({left:f})}var t=$(n.getEl()),i="responsive",u=t.children(".mce-container-body");r()},isDefined:function(t,i){return typeof i===n?typeof t===n?!1:t:typeof t===n||typeof t[i]===n?!1:t[i]},getTagName:function(n,t,i){var r=n.get(0).tagName.toLowerCase(),u;return typeof i=="undefined"&&typeof t=="undefined"?r:(typeof t!="undefined"&&typeof t!="boolean"&&(i=t),t===!0)?(inputs=["input","textarea","select"],$.inArray(r,inputs)!==-1?n.val():n.text()):typeof i=="object"?(u=[],$.each(i,function(n,t){u.push(t.toLowerCase())}),$.inArray(r,u)!=-1?!0:!1):r==i.toLowerCase()?!0:!1},cleanWhiteSpace:function(n){return n.contents().filter(function(){return this.nodeType==3&&!/\S/.test(this.nodeValue)}).remove(),n},isActiveButton:function(n){for(var i=[],r=this.getEditor(),t=1;typeof r.settings["toolbar"+t]!="undefined";t++)i=i.concat(r.settings["toolbar"+t].split(" "));return tinymce.inArray(i,n)==-1?!1:!0},getButtonByName:function(t,i){var e=this.getEditor(),o=e.buttons,s=e.theme.panel.find("toolbar *");if(typeof o[t]===n)return!1;var u=o[t],r=!1,f=0;return tinymce.each(u,function(){f++}),tinymce.each(s,function(t){if(t.type=="button"&&typeof t.settings!==n){var o=0;if(tinymce.each(t.settings,function(n,t){u[t]==n&&o++}),o==f)return r=t,i!=!1&&(r=t.getEl()),!1}}),r},getPathEl:function(n){var u=this.getEditor(),r=u.theme.panel&&u.theme.panel.find("#statusbar")[0],t,i;return r&&(t=r.find(".path"),typeof t[0]!="undefined")?(i=t[0].getEl(),n==!0?$(i):i):!1},getButtonsByProperty:function(t,i,r){var h=this.getEditor(),s=h.theme.panel.find("toolbar *"),u={},e;if(tinymce.each(s,function(r,f){var e=r.settings;r.type=="button"&&typeof e!==n&&(typeof i!==n&&typeof e[t]!==n&&e[t]==i?u[f]=r:(typeof i===n||i===null)&&typeof e[t]!==n&&(u[f]=r))}),typeof r!==n&&(e=$(),$.each(u,function(n,t){e=e.add($(t.getEl()))}),u=e),typeof r=="object"&&r instanceof jQuery){var c=r,f=[],o="_tmp_";$.each(u,function(n,t){f.push("#"+$(t).attr("id"))}),f=f.toString(),u=c.find(f).addClass(o).find(">:first-child").parents("."+o).removeClass(o)}return u},buildMenuItems:function(t,i,r,u){var o=[],e=[],f,s;return typeof i===n&&(i=t),tinymce.each(i.split(/\|/),function(n){e.push(n)}),tinymce.each(t.split(/\|/),function(t,i){if(f=typeof e[i]!==n?e[i]:"",typeof r===n||r==null)return o.push({text:t,value:f});var s={title:t,text:t,value:f,textStyle:r.replace(/{t}/g,t).replace(/{v}/g,f)};typeof u!==n&&(s.classes=u),o.push(s)}),o},createListBoxChangeHandler:function(n,t){return ed=this.getEditor(),function(){var i=this;ed.on("nodeChange",function(r){var f=ed.formatter,u=null;tinymce.each(r.parents,function(i){return tinymce.each(n,function(n){return t?f.matchNode(i,t,{value:n.value})&&(u=n.value):f.matchNode(i,n.value)&&(u=n.value),u?!1:void 0}),u?!1:void 0}),i.value(u)})}},insertBbCode:function(n,t,i){n=n.replace(/^at_/,"");var r=this.getEditor(),e=r.dom,u="MceCaretBb",s,f="["+n,o="[/"+n+"]";i||(i=r.selection.getContent()),i+='<span id="'+u+'"></span>',f+=t?"="+t+"]":"]",r.execCommand("mceInsertContent",!1,f+i+o),r.selection.select(e.get(u)),e.remove(u)},getParam:function(n){return typeof xenMCE.Params[n]!="undefined"?xenMCE.Params[n]:null},unescapeHtml:function(n,t){n=n.replace(/&amp;/g,"&").replace(/&lt;/g,"<").replace(/&gt;/g,">").replace(/&quot;/g,'"').replace(/&#039;/g,"'"),t=="noBlank"&&(n=n.replace(/	/g,"\t").replace(/&nbsp;/g,"  ").replace(/<\/p>\n<p>/g,"\n"));var i=new RegExp("^<p>([\\s\\S]+)</p>$","i");return i.test(n)&&(n=n.match(i),n=n[1]),n},escapeHtml:function(n,t){return t!=="onlyBlank"&&(n=n.replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;").replace(/"/g,"&quot;").replace(/'/g,"&#039;")),t!=="noBlank"&&(n=n.replace(/\t/g,"\t").replace(/ /g,"&nbsp;").replace(/\n/g,"</p>\n<p>")),n},getSelection:function(){return xenMCE.Overlay._get("selection")},zen2han:function(n){for(var t,r="",i=0,u=n.length;i<u;i++)t=n.charCodeAt(i),t=t>=65281&&t<=65392?t-65248:t,t=t===12540?45:t,r=r+String.fromCharCode(t);return r},static:{backupOverlay:{}}}),tinymce.PluginManager.add("xenforo",xenMCE.Tools);var t="xenMCE.Plugins.Auto";tinymce.create(t+".BbmButtons",{BbmButtons:function(t){$.extend(this,t),this.ed=this.getEditor();var r=this.ed,i=this,u=i.getParam("bbmButtons");$.each(u,function(t,u){var f=u.code;if(config={name:f,tooltip:u.desc},u.type=="manual"?(config.icon=f,u.typeOpt&&(config.classes=u.typeOpt)):u.type=="text"?(config.icon=!1,config.text=u.typeOpt):(config.icon=f,config.iconset=u.iconSet),u._return=="direct"?config.onclick=function(){i.insertBbCode(t,u.tagOpt,u.tagCont)}:u._return!="kill"&&(config.onclick=function(){var f,r;i.bbm_tag=t,i.bbm_separator=u.separator,f={onsubmit:i.submit},r={src:i,onafterload:"onafterload"},i.loadOverlay("bbm_"+u.template,f,r)}),u._return=="kill"){if(typeof r.buttons[u.code]===n){console.debug('Button "'+u.code+'" not found - Dev: activate your plugin before xenforo plugin / Admin: Delete it from the BBM');return}$.extend(r.buttons[u.code],config);return}i.ed.addButton(f,config)})},onafterload:function(t,i,r,u){var f=u.overlayParams.dialog.replace("bbm_","Bbm_");if(typeof xenMCE.Templates[f]!==n&&typeof xenMCE.Templates[f].onafterload!==n)xenMCE.Templates[f].onafterload(t,i,r,u)},submit:function(t,i,r,u){var f=u.overlayParams.dialog.replace("bbm_","Bbm_");typeof xenMCE.Templates[f]!==n&&typeof xenMCE.Templates[f].submit!==n&&xenMCE.Templates[f].submit(t,i,r,u)}}),tinymce.create(t+".XenSwitch",{XenSwitch:function(n){$.extend(this,n),this.ed=this.getEditor();var t="xen_switch";this.ed.addButton(t,{name:t,icon:t,iconset:"xenforo",xenfright:!0,tooltip:xenMCE.Phrases.switch_text[0],onclick:$.proxy(this,"wysiwygToBbCode")})},wysiwygToBbCode:function(){var i,t,r;this.isFullscreen()==!0&&(i=this.getButtonByName("fullscreen"),i!=!1&&$(i).trigger("click")),t={content:this.ed.getContent()},this.ed.fire("XenSwitchToBbCode",t),r=t.content,XenForo.ajax("index.php?editor/to-bb-code",{html:r},$.proxy(this,"wysiwygToBbCodeSuccess"))},wysiwygToBbCodeSuccess:function(n){if(!XenForo.hasResponseError(n)&&typeof n.bbCode!="undefined"&&(typeof n.isConnected=="undefined"||n.isConnected||this.ed.windowManager.alert(n.notConnectedMessage),$container=$(this.ed.getContainer()),$existingTextArea=$(this.ed.getElement()),$textContainer=$('<div class="bbCodeEditorContainer" />'),$newTextArea=$('<textarea class="textCtrl Elastic" rows="5" />'),!$existingTextArea.attr("disabled"))){var t=$existingTextArea.attr("name").replace(/_html(]|$)/,"");$newTextArea.attr("id",t).attr("name",t).val(n.bbCode).appendTo($textContainer),$("<a />").attr("href","javascript:").text(xenMCE.Phrases.switch_text[1]).click($.proxy(this,"bbCodeToWysiwyg")).appendTo($("<div />").appendTo($textContainer)),$existingTextArea.attr("disabled",!0),$container.after($textContainer).hide(),$textContainer.xfActivate(),$newTextArea.focus(),this.$bbCodeTextContainer=$textContainer,this.$bbCodeTextArea=$newTextArea}},bbCodeToWysiwyg:function(){XenForo.ajax("index.php?editor/to-html",{bbCode:this.$bbCodeTextArea.val()},$.proxy(this,"bbCodeToWysiwygSuccess"))},bbCodeToWysiwygSuccess:function(n){var t,i;XenForo.hasResponseError(n)||typeof n.html=="undefined"||(typeof n.isConnected=="undefined"||n.isConnected||this.ed.windowManager.alert(n.notConnectedMessage),$container=$(this.ed.getContainer()),$existingTextArea=$(this.ed.getElement()),$existingTextArea.attr("disabled"))&&($existingTextArea.attr("disabled",!1),$container.show(),t={content:n.html},this.ed.fire("XenSwitchToWysiwyg",t),i=t.content,this.ed.setContent(i),this.ed.focus(),this.$bbCodeTextContainer.remove())}}),tinymce.create(t+".XenFonts",{XenFonts:function(t){for(var i=t.getEditor(),v=tinymce.ui.Factory,h,f,a="xen-font-size",c="font-family",l="xen-"+c,s=xenMCE.Phrases,e="",u,o=t.isOldXen===!0?"xx-small|x-small|small|medium|large|x-large|xx-large":"9px|10px|12px|15px|18px|22px|26px",r=1;r<8;r++)e+=s.size+" "+r,r!=7&&(e+="|");h=t.buildMenuItems(e,o,"font-size:{v}",a),i.addButton("xen_fontsize",{name:"xen_fontsize",type:"listbox",values:h,icon:!1,fixedWidth:!0,text:s.font_size,onPostRender:t.createListBoxChangeHandler(h,"fontsize"),onShow:function(n){n.control.addClass(a+"-menu"),n.control.initLayoutRect()},onclick:function(n){n.control.settings.value&&i.execCommand("FontSize",!1,n.control.settings.value)}}),f=t.buildMenuItems("Andale Mono|Arial|Arial Black|Book Antiqua|Courier New|Georgia|Helvetica|Impact|Tahoma|Times New Roman|Trebuchet MS|Verdana","andale mono,times|arial,helvetica,sans-serif|arial black,avant garde|book antiqua,palatino|courier new,courier|georgia,palatino|helvetica|impact,chicago|tahoma,arial,helvetica,sans-serif|times new roman,times|trebuchet ms,geneva|verdana,geneva",c+":{v}",l),i.addButton("xen_fontfamily",{name:"xen_fontfamily",type:"listbox",values:f,icon:!1,fixedWidth:!0,text:s.font_family,onPostRender:t.createListBoxChangeHandler(f,"fontname"),onShow:function(n){n.control.addClass(l+"-menu"),n.control.initLayoutRect()},onclick:function(n){n.control.settings.value&&i.execCommand("FontName",!1,n.control.settings.value)}}),u={},$.each(f,function(n,t){u[t.title.toLowerCase()]=t.value});i.on("preInit",function(){i.on("PreProcess SetContent",function(t){var r=i.dom;tinymce.each(r.select("span",t.node),function(t){var i=t.style.fontFamily;i&&(i=i.toLowerCase().replace(/'/g,""),i!=="serif"&&typeof u[i]!==n&&r.setStyle(t,"fontFamily",u[i]))})})})}}),tinymce.create(t+".Fright",{Fright:function(n){if(n.getParam("frightMode")!=!0)return!1;$.extend(this,n);var r=this,t=this.getEditor(),i="mce-top-right-body";t.on("postrender",function(n){function f(){var t="mce-first",n="mce-last";u.each(function(){$(this).removeClass(t).removeClass(n)}).first().addClass(t).end().last().addClass(n).end()}var o=$(n.target.contentAreaContainer).prev(),u=r.getButtonsByProperty("xenfright",null,o),h=o.find(".mce-toolbar").first(),e,s;if(!u.length>0)return!1;u.click(function(){setTimeout(function(){f()},0)}),f(),e=$('<div id="mce-top-right" class="mce-container mce-flow-layout-item mce-btn-group" role="toolbar" />'),s=$('<div id="'+i+'" />').append(u),s.prependTo(e),e.prependTo(h);t.on("FullscreenStateChanged",function(){f()})})}}),tinymce.create(t+".Modal",{Modal:function(t){ed.on("XenModalComplete",function(i){function l(){o.children(".mce-container-body").addClass("mainBodyOverflow")}var h=i.modal,u=i.args,r=i.params,o=$(h.getEl()),f=!1,e=o.find(".noResponsive").length?!0:!1,c="mce-charmap",s;o.find("."+c).length>=1&&(f="modal-"+c,l()),r&&typeof r.disableResponsive!==n&&(e=r.disableResponsive),u&&typeof u.disableResponsive!==n&&(e=u.disableResponsive),(t.isOldXen===!0||t.getParam("disableResponsive"))&&(e=!0),e||t.responsiveModal(h),u&&typeof u.modalClassName!==n&&(f=u.modalClassName),r&&typeof r.modalClassName!==n&&(f=r.modalClassName),f&&h.addClass(f),s=o.find(".mce-btn:not(.mce-primary)"),s.width(s.width()+2)})}}),tinymce.create(t+".quirks",{quirks:function(n){var t=n.getEditor(),r="InlineMessageEditor",i;t.on("postrender",function(n){$container=$(t.getContainer()),$container.parents("form").hasClass(r)&&tinyMCE.activeEditor.execCommand("mceAutoResize",!1,n)});t.on("BeforeSetContent",function(i){function u(n){var t=/^(?:[\s]+)?<img[^>]*?\/>(?:[\s]+)?$/;return t.test(n)}function f(n){var t=/(class="[^"]+?(?="))/;return n=t.test(n)?n.replace(t,"$1 "+r):n.replace(/(<img)/,'$1 class="'+r+'" ')}if(n.getParam("extendInsert")){var r="tmp_"+(+new Date).toString(16);u(i.content)&&(i.content=f(i.content));t.on("ExecCommand",function(n){var l=n.command,o,f;if(l=="mceInsertContent"){var h=t.selection.getBookmark(),i=$(t.getBody()),s=i.find("#"+h.id+"_start"),c=s.offset().top,e=i.parent().add(i);if(t.selection.moveToBookmark(h),s.length)if(o=n.value,f={skip_focus:!0},u(o))i.find("img."+r).one("load",function(n){t.execCommand("mceAutoResize",!1,n,f);var i=$(this),o=i.offset(),u=o.top+i.height();i.removeClass(r),e.scrollTop(u)});else e.scrollTop(c),t.execCommand("mceAutoResize",!1,n,f)}})}});if(!n.isOldXen)return!1;t.on("postrender",function(){var i=t.getDoc();if($form=$(t.getContainer()).parents("form"),!tinymce.isIE&&$form.hasClass(r))try{t.settings.readonly||(i.designMode="On")}catch(u){}});n.getParam("geckoFullfix")&&(i=XenForo._overlayConfig.onBeforeLoad,XenForo._overlayConfig.onBeforeLoad=function(n){if(window.tinyMCE&&tinymce.isGecko&&$(this.getTrigger()).hasClass("edit")&&($mceTextarea=$(tinyMCE.activeEditor.getElement()),!$mceTextarea.attr("disabled"))){var t=$mceTextarea.attr("id");tinyMCE.execCommand("mceRemoveEditor",!1,t),tinyMCE.execCommand("mceAddEditor",!0,t),tinyMCE.activeEditor.focus()}typeof i=="function"&&i(n)})}}),tinymce.create(t+".TableIntegration",{TableIntegration:function(n){function i(n,i){var u=t.dom,r;(r=t.dom.getParent(t.selection.getStart(),"table"),typeof r!=un)&&($tableElm=$(r),$tableElm.attr("data-skin","skin"+i))}function r(n){var u=t.dom,r,i;if((r=t.dom.getParent(t.selection.getStart(),"table"),$skins=$(n.control.getEl()).find(".mce-text"),$skins.css("font-weight","normal"),typeof r!=un)&&($tableElm=$(r),i=$tableElm.attr("data-skin"),typeof i!=un)){if(i=parseInt(i.replace("skin","")),isNaN(i)||i>4)return!1;$skins.eq(i-1).css("font-weight","bold")}}this.ed=n.getEditor();var u=this,t=this.ed;t.addMenuItem("xen_tableskin",{name:"xen_tableskin",text:"Table skins",context:"table",onShow:r,menu:[{text:"Skin 1",onclick:function(n){i(n,1)}},{text:"Skin 2",onclick:function(n){i(n,2)}},{text:"Skin 3",onclick:function(n){i(n,3)}},{text:"Skin 4",onclick:function(n){i(n,4)}}]})}}),tinymce.create(t+".Fullscreen",{Fullscreen:function(n){var t=n.getEditor(),i;if(typeof t.buttons.fullscreen=="undefined")return!1;if(i=t.buttons.fullscreen,tinymce.isIE&&tinymce.Env.ie<=7)return delete t.buttons.fullscreen,!1;i.xenfright=!0;t.on("FullscreenStateChanged",function(n){$container=$(t.getContainer()),$(n.target.contentDocument).find("html").css("overflow","auto"),n.state==!1&&($("html, body").animate({scrollTop:$container.offset().top},300),t.focus())})}}),tinymce.create(t+".XenLink",{XenLink:function(n){$.extend(this,n),this.ed=this.getEditor();var u=this,t=this.ed,i={},r={};i={name:"xen_link",icon:"link",shortcut:"Ctrl+K",stateSelector:"a[href]",onclick:$.proxy(this,"init")},r={type:"splitbutton",menu:u.buildMenuItems(xenMCE.Phrases.unlink),onshow:function(){$(".mce-tooltip:visible").hide()},onselect:function(){t.execCommand("unlink")}},n.getParam("fastUnlink")&&$.extend(i,r),t.addButton("xen_link",i),t.addButton("xen_unlink",{name:"xen_unlink",icon:"unlink",cmd:"unlink",stateSelector:"a[href]"}),t.addMenuItem("xen_link",{name:"xen_link",icon:"link",shortcut:"Ctrl+K",stateSelector:"a[href]",onclick:$.proxy(this,"init"),text:xenMCE.Phrases.xen_link_desc,context:"insert",prependToContext:!0})},init:function(){var t=this.getParam("overlayLinkSize");config={width:t.w,height:t.h,onsubmit:this.submit},this.loadOverlay("link",config)},submit:function(n,t,i,r){xenMCE.Templates.Link.submit(n,t,i,r)}}),tinymce.create(t+".XenColors",{XenColors:function(n){function i(t){var u=t.panel.html,i=t.selectcmd,f=t.onclick;n.getParam("extraColors")==!0&&(t.panel.html=function(){var t='<div href="#" class="mceAdvPicker" data-mode="'+i+'">';return t+=xenMCE.Phrases.more_colors,t+="</div>",u()+t}),t.onshow=function(){var u=this,t,i;$(".mceAdvPicker").unbind("click").bind("click",function(n){n.preventDefault(),u.hidePanel();var t={mode:$(this).data("mode"),buttonCtrl:u};r.init(t)}),$button=$(this.getEl()),$panel=$(this.panel.getEl()),t=$button.offset(),i=$button.position(),t.top=r.isFullscreen()?i.top+$button.height()+parseInt($panel.css("marginTop")):t.top+$button.height()+parseInt($panel.css("marginTop")),$panel.offset(t)}}$.extend(this,n);var r=this,t=this.ed=this.getEditor(),u;typeof t.buttons.forecolor!="undefined"&&i(t.buttons.forecolor),typeof t.buttons.backcolor!="undefined"&&i(t.buttons.backcolor)},init:function(n){this._colorButton=n;var t=this.getParam("overlayColorPickerSize");config={width:t.w,height:t.h,onsubmit:$.proxy(this,"submit")},callbacks={src:this,onafterload:"onafterload"},this.loadOverlay("colors",config,callbacks)},onafterload:function(n,t,i,r){xenMCE.Templates.ColorPicker.init(n,t,i,r)},submit:function(n,t,i,r){r=this,xenMCE.Templates.ColorPicker.submit(n,t,i,r)}}),tinymce.create(t+".XenMedia",{XenMedia:function(n){$.extend(this,n),this.ed=this.getEditor();var i=this,t=this.ed;t.addButton("xen_media",{name:"xen_media",icon:"media",onclick:$.proxy(this,"init")})},init:function(){var t=this.getParam("overlayMediaSize");config={width:t.w,height:t.h,onsubmit:this.submit},this.loadOverlay("media",config)},submit:function(n,t,i,r){xenMCE.Templates.Media.submit(n,t,i,r)}}),tinymce.create(t+".XenImage",{XenImage:function(n){$.extend(this,n),this.ed=this.getEditor();var i=this,t=this.ed;t.addButton("xen_image",{name:"xen_image",icon:"image",stateSelector:"img:not([data-mce-object],[data-smilie])",onclick:$.proxy(this,"init")})},init:function(){var i=this.ed.selection.getNode(),t=this.getParam("overlayImageSize");config={width:t.w,height:t.h,onsubmit:this.submit},i.nodeName=="IMG"&&(config.data={url:this.ed.dom.getAttrib(i,"src")}),this.loadOverlay("image",config)},submit:function(n,t,i,r){xenMCE.Templates.Image.submit(n,t,i,r)}}),tinymce.create(t+".XenCode",{XenCode:function(n){$.extend(this,n),this.ed=this.getEditor();var r=this,i=this.ed,t="xen_code";i.addButton(t,{name:t,icon:t,iconset:"xenforo",onclick:$.proxy(this,"init")})},init:function(){config={width:480,height:300,onsubmit:this.submit},this.loadOverlay("code",config)},submit:function(n,t,i,r){xenMCE.Templates.Code.submit(n,t,i,r)}}),tinymce.create(t+".XenQuote",{XenQuote:function(n){var i=n.getEditor(),t="xen_quote";i.addButton(t,{name:t,icon:t,iconset:"xenforo",onclick:function(){n.insertBbCode("quote",!1)}})}}),tinymce.create(t+".XenSmilies",{XenSmilies:function(n){function u(i){function f(i,r){return tinymce.each(r,function(r,u){var l=t.dom,f={id:r[1],desc:r[0],bbcode:l.encode(u)},h=n.getParam("smiliesDesc");if(h=="bbcode"?f.desc=u:h=="none"&&(f.desc=""),o!=0&&c>o)return!1;i+=typeof f.id=="number"?'<a href="#"><img src="styles/default/xenforo/clear.png" alt="'+f.bbcode+'" title="'+f.desc+'" '+s+' class="'+e+" "+e+"Sprite mceSmilie"+f.id+'"  /></a>':'<a href="#"><img src="'+l.encode(f.id)+'" alt="'+f.bbcode+'" title="'+f.desc+'" '+s+' class="'+e+'" /></a>',c++}),i}var c=1,o,e="mceQuattroSmilie",l="",u=n.getParam("xenforo_smilies"),a=n.getParam("smiliesCat"),h=n.getParam("xCatSmilies"),r,s;return i===!0?(o=0,l="Full"):o=n.getParam("xSmilies"),r='<div role="presentation" class="'+e+"Block"+l+' responsiveBlock">',s='data-smilie="yes"',a?i!==!0&&h!=-1&&typeof u[h]!="undefined"?r+=f("",u[h].smilies):tinymce.each(u,function(n){i===!0?(r+='<p class="mce_smilie_cat_title">'+n.title+"</p>",r+='<div class="mce_smilie_cat">'+f("",n.smilies)+"</div>"):r+=f("",n.smilies)}):r=f(r,u),r+="</div>"}function h(){return u()}function s(){var r=u(!0),i={type:"container",html:r,onclick:function(n){var i,r;n.preventDefault(),i=t.dom.getParent(n.target,"a"),i&&(r=$(i).html(),t.execCommand("mceInsertContent",!1,r))}},n=t.windowManager.open({title:"Smilies picker",spacing:10,padding:10,items:[i],buttons:[{text:"Close",onclick:function(){n.close()}}]},{modalClassName:"modal-smilies"})}var i;$.extend(this,n);var o=this,t=this.getEditor(),f="xen_smilies",r="xen_smilies_picker",e=n.getParam("smiliesWindow");t.addButton(f,{name:f,icon:"emoticons",type:"panelbutton",stateSelector:"img[data-smilie]",popoverAlign:"bc-tl",panel:{autohide:!0,html:h,onclick:function(n){var r=t.dom.getParent(n.target,"a"),i;r&&(i=$(r).html(),t.execCommand("mceInsertContent",!1,i),this.hide())}}}),i={name:r,icon:r,iconset:"xenforo",tooltip:"Smilies picker",stateSelector:"img[data-smilie]"},i.onclick=e=="slider"?$.proxy(this,"initOvl"):e!="belowbox"||this.isOldXen?s:function(n){o.initBox(this,n,t)},t.addButton(r,i)},initOvl:function(){var t=this.getParam("overlaySmiliesSize");config={width:parseInt(t.w),height:parseInt(t.h)},callbacks={src:this,onafterload:"onafterload"},this.loadOverlay("smilies_slider",config,callbacks)},onafterload:function(n,t,i,r){xenMCE.Templates.SmiliesSlider.init(n,t,i,r)},initBox:function(n,t,i){var u=this,f=$(i.getContainer()).parent(),r=f.find(".redactor_smilies");if(r.length){r.slideToggle("slow",function(){n.active(r.is(":visible"))});return}u.smiliesPending||(u.smiliesPending=!0,XenForo.ajax("index.php?editor/smilies",{mce:"mce4"},function(n){XenForo.hasResponseError(n)||n.templateHtml&&new XenForo.ExtLoader(n,function(){r=$('<div class="redactor_smilies mce" />').html(n.templateHtml),r.hide();r.on("click",".Smilie",function(n){n.preventDefault();var r=$(this),t=$.trim(r.html());i.execCommand("mceInsertContent",!1,t),i.focus()});f.append(r),r.slideToggle()})}).complete(function(){u.smiliesPending=!1,n.active(!0)}))}}),tinymce.create(t+".XenNonBreaking",{XenNonBreaking:function(n){var t=n.getEditor(),r="xen_nonbreaking",i="XenNonBreaking";if(t.addCommand(i,function(){t.insertContent(t.plugins.visualchars&&t.plugins.visualchars.state?'<span data-mce-bogus="1" class="mce-nbsp">&nbsp;</span>':"&nbsp;")}),t.addButton(r,{name:r,cmd:i}),t.getParam("nonbreaking_force_tab"))t.on("keydown",function(n){if(n.keyCode==9){n.preventDefault();for(var r=0;r<4;)t.execCommand(i),r++}})}}),tinymce.create(t+".XenDraft",{XenDraft:function(n){var u,f;if(n.isOldXen)return!1;this.ed=n.getEditor(),this.draftText=xenMCE.Phrases.draft,this.$textarea=n.$textarea,this.autoSaveUrl=this.$textarea.data("auto-save-url");var t=this,i=this.ed,o={},e="Draft mode: ",r="restoredraft";if(!this.autoSaveUrl||!n.getParam("xendraft")){console.info(e+"Mce");return}console.info(e+"Xen"),u=n.buildMenuItems(t.draftText.save+"|"+t.draftText._delete,"saveDraft|deleteDraft",null,"xen_draft"),f=function(n){t.saveDraft(!0,n.control.settings.value=="deleteDraft")};i.on("BeforeRenderUI",function(){if(!n.isActiveButton(r))return!1});i.addButton(r,{name:r,title:t.draftText.save,type:"menubutton",menu:u,onselect:f});i.on("init",function(){t.pathEl=n.getPathEl(!0),t.initAutoSave()});i.addCommand("xenDraftSave",function(){t.saveDraft(!0)}),i.addCommand("xenDraftDelete",function(){t.saveDraft(!0,!0)})},initAutoSave:function(){var n=this,u=$(this.ed.getContainer()).parents("form"),i=n.$textarea.data("options"),r=this.ed.getContent(),t;u.length&&(this.lastAutoSaveContent=r,t=setInterval(function(){if(!n.$textarea.data("mce4")){clearInterval(t);return}n.saveDraft()},(i.autoSaveFrequency||60)*1e3))},saveDraft:function(n,t){var r=this,f=$(this.ed.getContainer()).parents("form"),o=this.ed.windowManager,e={content:this.ed.getContent()},u="",i;return(this.ed.fire("SavingXenDraft",e),u=e.content,!t&&!n&&u==this.lastAutoSaveContent)?!1:(this.lastAutoSaveContent=u,i=$.Event("BbCodeWysiwygEditorAutoSave"),i.editor=this,i.content=u,i.deleteDraft=t,f.trigger(i),i.isDefaultPrevented())?!1:this.autoSaveRunning?!1:(this.autoSaveRunning=!0,XenForo.ajax(this.autoSaveUrl,f.serialize()+(t?"&delete_draft=1":""),function(i){var e=$.Event("BbCodeWysiwygEditorAutoSaveComplete"),u;if(e.ajaxData=i,f.trigger(e),!e.isDefaultPrevented()){if(i.draftSaved?u=r.draftText.saved:i.draftDeleted&&(u=r.draftText.deleted),!u)return;if(n||t){o.alert(u);return}if(r.pathEl==!1){console.log(r.draftText.saved);return}$path=r.pathEl,$('<div class="draftNotice"><span>'+u+"</span></div>").insertAfter($path).css({display:"inline-block",padding:"8px"}).finish().hide().fadeIn().delay(2e3).fadeOut()}},{global:!1}).complete(function(){r.autoSaveRunning=!1}),!0)}}),tinymce.create(t+".XenIcons",{XenIcons:function(t){function r(t){typeof i.buttons[t].type!==n&&(i.buttons[t].type="button")}var i=t.getEditor(),u=xenMCE.Phrases;i.on("BeforeRenderUI",function(){function u(t){typeof i.menuItems[t]!==n&&delete i.menuItems[t]}if(t.isActiveButton("xen_link")||u("xen_link"),!t.isActiveButton("table")){var f=["inserttable","xen_tableskin","cell","row","column","deletetable"];tinymce.each(f,function(n){u(n)})}});tinymce.each(i.buttons,function(t,r){var f=r+"_desc";XenForo.isTouchBrowser()?typeof i.buttons[r].tooltip!==n&&delete i.buttons[r].tooltip:typeof u[f]!==n&&(i.buttons[r].tooltip=u[f])}),t.getParam("extraLists")!=!0&&(r("bullist"),r("numlist"));i.on("init",function(){$buttons=t.getButtonsByProperty("iconset","xenforo",!0),$buttons.find("i.mce-ico").addClass("mce-xenforo-icons");var r=i.theme.panel.find("#statusbar");r&&r.length>0&&($statBar=$(r[0].getEl())),t.getParam("hidePath")&&r.length>0&&$statBar.find(".mce-path").css("visibility","hidden")})}})})("undefined");