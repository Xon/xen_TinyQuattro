(function(n,t,i,r){xenMCE==r&&(xenMCE={}),xenMCE.Lib={getTools:function(){return this.Tools},overlay:{create:function(n,t,i){xenMCE.Lib.Tools.loadOverlay(n,t,i)},get:function(){return xenMCE.Lib._get("$overlay")},getParams:function(){return xenMCE.Lib._get("params")},getInputs:function(){return xenMCE.Lib._get("inputs")},getEditor:function(){return xenMCE.Lib._get("editor")},getSelection:function(){return xenMCE.Lib._get("selection")}},_get:function(n){var t=xenMCE.Tools.backupLib;return t[n]!==r?t[n]:!1}},xenMCE.Templates={},tinymce.create("xenMCE.Tools",{Tools:function(t){var i=this,u=this.static;t===r&&(t=tinymce.activeEditor);t.on("init",function(){n(t.getElement()).data("mce4",!0)});this.$textarea=n(t.getElement()),this.isOldXen=i.getParam("oldXen");t.on("init",function(){var i=t.windowManager,u=i.open;i.open=function(n,i){var e,f;return n===r&&(n=!1),i===r&&(i=!1),f={args:n,params:i},t.fire("XenModalInit",f),e=u(n,i),f={modal:e,args:n,params:i},t.fire("XenModalComplete",f),e}});this.getEditor=function(){return t},this.isFullscreen=function(){return t.plugins.fullscreen===r?!1:t.plugins.fullscreen.isFullscreen()},xenMCE.Lib.Tools=this;t.on("XenReady",function(){xenMCE.Plugins.Auto!==r&&n.each(xenMCE.Plugins.Auto,function(n,t){new t(i)})})},overlayParams:{},overlayInputs:{},loadOverlay:function(t,i,r){var o;if(this.xenOverlayIsloading==!0)return!1;this.xenOverlayIsloading=!0;var f=this,l=this.getEditor(),a=l.dom,h=isLink=isEmail=!1,c=url_href="",u=l.selection,s,e,y=e?0:1,v=xenMCE.Tools.backupLib;selElm=u.getNode(),anchorElm=a.getParent(selElm,"a[href]"),anchorElm&&(h=!0,u.select(anchorElm),c=u.getContent({format:"text"}),url_href=anchorElm?a.getAttrib(anchorElm,"href"):"",isEmail=url_href.indexOf("mailto")==0&&url_href.indexOf("@")>0&&url_href.indexOf("//")==-1?!0:!1,isLink=!isEmail),o=ed.settings.xen_attach.split(","),xenAttach={type:o[0],id:o[1],hash:o[2]},s=u.getContent(),e=u.getContent({format:"text"}),v.selection={sel:u,text:e,html:s,isUrl:h,isLink:isLink,isEmail:isEmail,url:{text:c,href:url_href,anchorElm:anchorElm}},typeof i!="object"&&(i={}),this.overlayParams={dialog:t,src:f.isDefined(r,"src"),onbeforeload:f.isDefined(r,"onbeforeload"),onafterload:f.isDefined(r,"onafterload"),onsubmit:f.isDefined(r,"onsubmit"),onclose:f.isDefined(r,"onclose"),wmConfig:i},XenForo.ajax("index.php?editor/quattro-dialog",{dialog:t,selectedHtml:s,selectedText:e,isUrl:h,isLink:isLink,isEmail:isEmail,urlDatas:{text:c,href:url_href},attach:xenAttach},n.proxy(this,"_overlayLoader"))},_overlayLoader:function(t){if(XenForo.hasResponseError(t)||typeof t.templateHtml!="string"){f.xenOverlayIsloading=!1;return}for(var f=this,e=this.getEditor(),u=this.overlayParams,i=u.wmConfig,h='<div><div class="mce-xen-body">'+t.templateHtml+"</div></div>",o={},c=/<script[^>]*>([\s\S]*?)<\/script>/ig,l,s=[];l=c.exec(h);)s.push(l[1]);h=h.replace(c,""),new XenForo.ExtLoader(t,function(){function l(t){return $inputs=t.find(d.toString()),$inputs.length>0&&$inputs.each(function(){var i=n(this).attr("name");i&&(o[i]=n(this).val())}),t.find("*").filter(function(){n(this).data("value")&&(o[n(this).attr("name")]={html:n(this).html(),text:n(this).text(),data:n(this).data("value")}),parseInt(n(this).data("hide"))==1&&n(this).hide()}),f.overlayInputs=o,b.inputs=o,o}var y=e.windowManager,p=xenMCE.Phrases,k=p.insert,g=p.cancel,d=["input","textarea","select"],b=xenMCE.Tools.backupLib,v,w,tt,nt,c,t,a;if(b.params=u,b.editor=e,$html=n(h),$title=$html.find(".mceTitle").remove(),$Submit=$html.find(".mceSubmit").remove(),$Cancel=$html.find(".mceCancel").remove(),$Submit.length==1&&(k=f.getTagName($Submit,!0)),$Cancel.length==1&&(g=f.getTagName($Cancel,!0)),l($html),$title&&(i.title=$title.text()),i.title!==r&&i.title||(i.title=p.notitle),v=f.getParam("overlayDefaultSize"),i.width===r&&(i.width=v.w),i.height===r&&(i.height=v.h),$title.data("width")!==r&&(i.width=parseInt($title.data("width"))),$title.data("height")!==r&&(i.height=parseInt($title.data("height"))),i.data!==r?(n.each(i.data,function(t,i){$e=$html.find("[name="+t+"]"),$e.length==1&&(f.getTagName($e,d)?n('<span class="tmp-data-mce">'+i+"</span>").insertAfter($e).hide():$e.html(i))}),n.extend(i.data,o)):i.data=o,i.onsubmit!==r&&(originalSubmit=i.onsubmit,i.onsubmit=function(t){var i=n(e.windowManager.windows[0].getEl());xenDatas=l(i),n.extend(t.data,xenDatas),originalSubmit(t,i,e,f)}),i.buttons===r&&(i.buttons=[{text:k,subtype:"primary xenSubmit",minWidth:80,onclick:function(t){var i=e.windowManager.windows[0],o;$overlay=n(i.getEl()),u.onsubmit!=!1&&(o=l($overlay),n.extend(t.data,o),u.src[u.onsubmit](t,$overlay,e,f)),i.find("form")[0]!==r?i.find("form")[0].submit():i.submit(),u.onclose!=!1&&(o=l($overlay),n.extend(t.data,o),u.src[u.onclose](t,$overlay,e,f)),i.close()}},{text:g,subtype:"xenCancel",onclick:function(t){var r=e.windowManager.windows[0],i;$overlay=n(r.getEl()),u.onclose!=!1&&(i=l($overlay),n.extend(t.data,i),u.src[u.onclose](t,$overlay,e,f)),r.close()}}]),i.html=$html.html(),u.onbeforeload!=!1&&(w=u.src[u.onbeforeload](i,f),w!==r&&(i=w)),tt=y.open(i,{dialogName:u.dialog,modalClassName:u.dialog,ovlParams:u}),$overlay=n(y.windows[0].getEl()),xenMCE.Tools.backupLib.$overlay=$overlay,s.length)for(c=0;c<s.length;c++)n.globalEval(s[c]);nt=$overlay.children(".mce-container-body").height(),$overlay.find(".mceFocus").focus(),$overlay.find(".tmp-data-mce").each(function(){$e=n(this),$e.prev().val($e.html()),$e.remove()}),$tabs=$overlay.find(".mceTabs").addClass("mce-tabs"),$tabs=f.cleanWhiteSpace($tabs),$panes=$tabs.next(".mcePanes").children().addClass("mce-pane"),$tabs.length>0&&$panes.length>0&&($tabs.children().addClass("mce-tab"),c=$tabs.find(".mceActive").index(),$tabs.tabs($panes,{current:"mce-active",initialIndex:c>=0?c:0})),t="mceSlides",$slides=$overlay.find("."+t),$slides.length>0&&(a=nt,$slides.height(a).children().height(a-$slides.data("diff")),$slider_tabs=$overlay.find("."+t+"Tabs"),n('<a class="'+t+"Navig "+t+'Backward">&lsaquo;</a><a class="'+t+"Navig "+t+'Forward">&rsaquo;</a>').insertBefore($slides),$overlay.find("."+t+"Navig").css("top",a/2-10+"px"),$slider_tabs.tabs($slides.children(),{effect:"fade",fadeOutSpeed:"fast",rotate:!0}).slideshow({prev:"."+t+"Backward",next:"."+t+"Forward",clickable:!1})),$multi=$overlay.find("textarea, .mce-multiline"),$multi&&(y.windows[0].off("keydown"),$multi.attr("spellcheck","false").attr("hidefocus","true")),$checkBox=$overlay.find(".xenCheckBox"),$checkBox.length>1&&($checkBox.each(function(){var u=n(this).data("phrase"),f=n(this).data("inputname"),i=n(this).data("checked")=="checked"?1:0,r='<i class="mce-ico mce-i-checkbox"></i><span>'+u+'</span><input name="'+f+'" type="hidden" value="'+i+'" />';i&&n(this).addClass("mce-checked"),n(r).prependTo(n(this))}),f._initCheckBox($checkBox)),$overlay.xfActivate(),u.onafterload!=!1&&u.src[u.onafterload]($overlay,o,e,f),f.xenOverlayIsloading=!1})},_initCheckBox:function(t){t.children("i").unbind("click").bind("click",function(){$parent=n(this).parent(),$input=n(this).siblings("input");var r=parseInt($input.val()),i="mce-checked";r?($parent.removeClass(i),$input.val(0)):($parent.addClass(i),$input.val(1))})},responsiveModal:function(t){function u(){var e=(n(window).width()-i.width())/2,u=i.find(".mce-xen-body"),c=u.css("overscroll"),a=i.find("mce-foot");if(e<0){e=1,t.addClass(r),i.children().add(u).addClass(r);var s=n(window).width(),o=s-5,h=i.find("*").filter(function(){function i(t){return t.indexOf("%")!=-1?!1:parseInt(t)>=s?(n(this).data("owidth")||n(this).data("owidth",t),!0):void 0}var r=n(this).prop("style").width,u=n(this).css("width"),t;return(t=i(r),t==!0)?!0:(t=i(u),n(this).css("width")==n(this).parent().css("width"))?!1:t==!0?!0:!1}),l=i.find("*").filter(function(){var t=n(this).css("white-space");return t!="normal"&&!n(this).data("onw")?(n(this).data("onw",t),!0):!1});h.add(i).css({"max-width":o+"px"}),i.find(".responsiveBlock").css({"max-width":o-15+"px"}),i.find(".mainBodyOverflow").length&&f.css("overflow","auto"),i.find(".disableXenBodyOverflow").length==0&&u.data("ovsc",c).css("overflow","auto"),l.css({"white-space":"normal"})}i.css({left:e})}var i=n(t.getEl()),r="responsive",f=i.children(".mce-container-body");u()},isDefined:function(n,t){return t===r?n===r?!1:n:n===r||n[t]===r?!1:n[t]},getTagName:function(t,i,u){var f=t.get(0).tagName.toLowerCase(),e;return u===r&&i===r?f:(i!==r&&typeof i!="boolean"&&(u=i),i===!0)?(inputs=["input","textarea","select"],n.inArray(f,inputs)!==-1?t.val():t.text()):typeof u=="object"?(e=[],n.each(u,function(n,t){e.push(t.toLowerCase())}),n.inArray(f,e)!=-1?!0:!1):f==u.toLowerCase()?!0:!1},cleanWhiteSpace:function(n){return n.contents().filter(function(){return this.nodeType==3&&!/\S/.test(this.nodeValue)}).remove(),n},isActiveButton:function(n){for(var i=[],u=this.getEditor(),t=1;u.settings["toolbar"+t]!==r;t++)i=i.concat(u.settings["toolbar"+t].split(" "));return tinymce.inArray(i,n)==-1?!1:!0},getButtonByName:function(n,t){var e=this.getEditor(),o=e.buttons,s=e.theme.panel.find("toolbar *");if(o[n]===r)return!1;var u=o[n],i=!1,f=0;return tinymce.each(u,function(){f++}),tinymce.each(s,function(n){if(n.type=="button"&&n.settings!==r){var o=0;if(tinymce.each(n.settings,function(n,t){u[t]==n&&o++}),o==f)return i=n,t!=!1&&(i=n.getEl()),!1}}),i},getPathEl:function(t){var e=this.getEditor(),f=e.theme.panel&&e.theme.panel.find("#statusbar")[0],i,u;return f&&(i=f.find(".path"),i[0]!==r)?(u=i[0].getEl(),t==!0?n(u):u):!1},getButtonsByProperty:function(t,i,u){var c=this.getEditor(),h=c.theme.panel.find("toolbar *"),f={},o;if(tinymce.each(h,function(u,e){var o=u.settings;n.inArray(u.type,["button","splitbutton"])!==-1&&o!==r&&(i!==r&&o[t]!==r&&o[t]==i?f[e]=u:(i===r||i===null)&&o[t]!==r&&(f[e]=u))}),u!==r&&(o=n(),n.each(f,function(t,i){o=o.add(n(i.getEl()))}),f=o),typeof u=="object"&&u instanceof jQuery){var l=u,e=[],s="_tmp_";n.each(f,function(t,i){e.push("#"+n(i).attr("id"))}),e=e.toString(),f=l.find(e).addClass(s).find(">:first-child").parents("."+s).removeClass(s)}return f},buildMenuItems:function(n,t,i,u){var o=[],e=[],f,s;return t===r&&(t=n),tinymce.each(t.split(/\|/),function(n){e.push(n)}),tinymce.each(n.split(/\|/),function(n,t){if(f=e[t]!==r?e[t]:"",i===r||i==null)return o.push({text:n,value:f});var s={title:n,text:n,value:f,textStyle:i.replace(/{t}/g,n).replace(/{v}/g,f)};u!==r&&(s.classes=u),o.push(s)}),o},createListBoxChangeHandler:function(n,t,i){return ed=this.getEditor(),function(r){var u=this;typeof i=="function"&&i(u,r);ed.on("nodeChange",function(i){if(!u.nodeChangeOff){var f=ed.formatter,r=null;tinymce.each(i.parents,function(i){return tinymce.each(n,function(n){return t?f.matchNode(i,t,{value:n.value})&&(r=n.value):f.matchNode(i,n.value)&&(r=n.value),r?!1:void 0}),r?!1:void 0}),u.value(r),u.resetText&&u.text(!1)}})}},fixBtnFullscreen:function(t,i){var e=this;if(!e.isFullscreen())return!1;var u=n(t.getEl()),f=n(t[i].getEl()),r=u.offset(),o=u.position();r.top=e.isFullscreen()?o.top+u.height()+parseInt(f.css("marginTop")):r.top+u.height()+parseInt(f.css("marginTop")),f.offset(r)},insertBbCode:function(n,t,i){n=n.replace(/^at_/,"");var r=this.getEditor(),e=r.dom,u="MceCaretBb",s,f="["+n,o="[/"+n+"]";i||(i=r.selection.getContent()),i+='<span id="'+u+'"></span>',f+=t?"="+t+"]":"]",r.execCommand("mceInsertContent",!1,f+i+o),r.selection.select(e.get(u)),e.remove(u)},getParam:function(n){return xenMCE.Params[n]!==r?xenMCE.Params[n]:null},unescapeHtml:function(n,t){n=n.replace(/&amp;/g,"&").replace(/&lt;/g,"<").replace(/&gt;/g,">").replace(/&quot;/g,'"').replace(/&#039;/g,"'"),t=="noBlank"&&(n=n.replace(/	/g,"\t").replace(/&nbsp;/g,"  ").replace(/<\/p>\n<p>/g,"\n"));var i=new RegExp("^<p>([\\s\\S]+)</p>$","i");return i.test(n)&&(n=n.match(i),n=n[1]),n},escapeHtml:function(n,t){return t!=="onlyBlank"&&(n=n.replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;").replace(/"/g,"&quot;").replace(/'/g,"&#039;")),t!=="noBlank"&&(n=n.replace(/\t/g,"\t").replace(/ /g,"&nbsp;").replace(/\n/g,"</p>\n<p>")),n},getSelection:function(){return xenMCE.Lib._get("selection")},zen2han:function(n){for(var t,r="",i=0,u=n.length;i<u;i++)t=n.charCodeAt(i),t=t>=65281&&t<=65392?t-65248:t,t=t===12540?45:t,r=r+String.fromCharCode(t);return r},static:{backupLib:{}}}),tinymce.PluginManager.add("xenforo",xenMCE.Tools),tinymce.PluginManager.add("xenReady",function(n){n.fire("XenReady")});var u="xenMCE.Plugins.Auto";tinymce.create(u+".BbmButtons",{BbmButtons:function(t){n.extend(this,t),this.ed=this.getEditor();var u=this.ed,i=this,f=i.getParam("bbmButtons");n.each(f,function(t,f){var e=f.code;if(config={name:e,tooltip:f.desc},f.type=="manual"?(config.icon=e,f.typeOpt&&(config.classes=f.typeOpt)):f.type=="text"?(config.icon=!1,config.text=f.typeOpt):(config.icon=e,config.iconset=f.iconSet),f._return=="direct"?config.onclick=function(){i.insertBbCode(t,f.tagOpt,f.tagCont)}:f._return!="kill"&&(config.onclick=function(){var u,r;i.bbm_tag=t,i.bbm_separator=f.separator,u={onsubmit:i.submit},r={src:i,onafterload:"onafterload",onclose:"onclose"},i.loadOverlay("bbm_"+f.template,u,r)}),f._return=="kill"){if(u.buttons[f.code]===r){console.debug('Button "'+f.code+'" not found - Dev: activate your plugin before xenforo plugin / Admin: Delete it from the BBM');return}n.extend(u.buttons[f.code],config);return}i.ed.addButton(e,config)}),i.ed.buttons.code!==r&&(i.ed.buttons.code.xenfright=!0)},onafterload:function(n,t,i,u){var f=u.overlayParams.dialog.replace("bbm_","Bbm_");if(xenMCE.Templates[f]!==r&&xenMCE.Templates[f].onafterload!==r)xenMCE.Templates[f].onafterload(n,t,i,u)},onclose:function(n,t,i,u){var f=u.overlayParams.dialog.replace("bbm_","Bbm_");if(xenMCE.Templates[f]!==r&&xenMCE.Templates[f].onclose!==r)xenMCE.Templates[f].onclose(n,t,i,u)},submit:function(n,t,i,u){var f=u.overlayParams.dialog.replace("bbm_","Bbm_");xenMCE.Templates[f]!==r&&xenMCE.Templates[f].submit!==r&&xenMCE.Templates[f].submit(n,t,i,u)}}),tinymce.create(u+".XenSwitch",{XenSwitch:function(t){n.extend(this,t),this.ed=this.getEditor();var i="xen_switch";this.ed.addButton(i,{name:i,icon:i,iconset:"xenforo",xenfright:!0,tooltip:xenMCE.Phrases.switch_text[0],onclick:n.proxy(this,"wysiwygToBbCode")})},wysiwygToBbCode:function(){var r,i,u;this.isFullscreen()==!0&&(r=this.getButtonByName("fullscreen"),r!=!1&&n(r).trigger("click")),i={content:this.ed.getContent()},this.ed.fire("XenSwitchToBbCode",i),u=i.content,XenForo.ajax("index.php?editor/to-bb-code",{html:u},n.proxy(this,"wysiwygToBbCodeSuccess"))},wysiwygToBbCodeSuccess:function(t){if(!XenForo.hasResponseError(t)&&t.bbCode!==r&&(t.isConnected===r||t.isConnected||this.ed.windowManager.alert(t.notConnectedMessage),$container=n(this.ed.getContainer()),$existingTextArea=n(this.ed.getElement()),$textContainer=n('<div class="bbCodeEditorContainer" />'),$newTextArea=n('<textarea class="textCtrl Elastic" rows="5" />'),!$existingTextArea.attr("disabled"))){var i=$existingTextArea.attr("name").replace(/_html(]|$)/,"");$newTextArea.attr("id",i).attr("name",i).val(t.bbCode).appendTo($textContainer),n("<a />").attr("href","javascript:").text(xenMCE.Phrases.switch_text[1]).click(n.proxy(this,"bbCodeToWysiwyg")).appendTo(n("<div />").appendTo($textContainer)),$existingTextArea.attr("disabled",!0),$container.after($textContainer).hide(),$textContainer.xfActivate(),$newTextArea.focus(),this.$bbCodeTextContainer=$textContainer,this.$bbCodeTextArea=$newTextArea}},bbCodeToWysiwyg:function(){XenForo.ajax("index.php?editor/to-html",{bbCode:this.$bbCodeTextArea.val()},n.proxy(this,"bbCodeToWysiwygSuccess"))},bbCodeToWysiwygSuccess:function(t){var i,u;XenForo.hasResponseError(t)||t.html==r||(t.isConnected===r||t.isConnected||this.ed.windowManager.alert(t.notConnectedMessage),$container=n(this.ed.getContainer()),$existingTextArea=n(this.ed.getElement()),$existingTextArea.attr("disabled"))&&($existingTextArea.attr("disabled",!1),$container.show(),i={content:t.html},this.ed.fire("XenSwitchToWysiwyg",i),u=i.content,this.ed.setContent(u),this.ed.focus(),this.$bbCodeTextContainer.remove())}}),tinymce.create(u+".XenFonts",{XenFonts:function(i){for(var u=i.getEditor(),rt=tinymce.ui.Factory,h,o,nt="font-size",w="xen-"+nt,a="fontsize",p="font-family",k="xen-"+p,d="fontfamily",tt="mce-xenforo-icons",c="",s=xenMCE.Phrases,it=i.getParam("smallFontBtn"),v,e,l=i.isOldXen===!0?"xx-small|x-small|small|medium|large|x-large|xx-large":"9px|10px|12px|15px|18px|22px|26px",f=1;f<8;f++)c+=s.size+" "+f,f!=7&&(c+="|");h=i.buildMenuItems(c,l,"font-size:{v}",w);var b=function(i){var f=function(){var o=n(u.getContainer()),e="fixed-width",r=!1,f=function(){var t=o.width();if(t<450||it)i.resetText=!0,i.text(!1),r||(i.icon(i._name+" "+tt),i.removeClass(e),r=!0);else if(t>=450&&r){function u(){var r=i._value,t=i.settings.text;return r!=null&&n.each(i._values,function(n,i){if(i.value==r)return t=i.text,!1}),t}i.resetText=!1,i.text(u()),i.icon(!1),i.addClass(e),r=!1}};f();i.on("click",f);n(t).resize(f)};u.on("postrender",f)},y=function(t){var u=t.menu,i,r;u&&(i=n(u.getEl()).children().first(),r=i.find('[aria-pressed="true"]'),r.length?i.scrollTop(i.scrollTop()+r.position().top):i.scrollTop(0))},g={name:"xen_"+a,type:"listbox",icon:!1,fixedWidth:!0,text:s.font_size,values:h,onPostRender:i.createListBoxChangeHandler(h,a,b),onShow:function(n){n.control.addClass(w+"-menu"),n.control.initLayoutRect(),i.fixBtnFullscreen(this,"menu"),y(this)},onclick:function(n){n.control.settings.value&&u.execCommand("FontSize",!1,n.control.settings.value)}};u.addButton("xen_"+a,g),o=i.buildMenuItems("Andale Mono|Arial|Arial Black|Book Antiqua|Courier New|Georgia|Helvetica|Impact|Tahoma|Times New Roman|Trebuchet MS|Verdana","andale mono,times|arial,helvetica,sans-serif|arial black,avant garde|book antiqua,palatino|courier new,courier|georgia,palatino|helvetica|impact,chicago|tahoma,arial,helvetica,sans-serif|times new roman,times|trebuchet ms,geneva|verdana,geneva",p+":{v}",k),v={name:"xen_"+d,type:"listbox",icon:!1,fixedWidth:!0,text:s.font_family,values:o,onPostRender:i.createListBoxChangeHandler(o,"fontname",b),onShow:function(n){n.control.addClass(k+"-menu"),n.control.initLayoutRect(),i.fixBtnFullscreen(this,"menu"),y(this)},onclick:function(n){n.control.settings.value&&u.execCommand("FontName",!1,n.control.settings.value)}},u.addButton("xen_fontfamily",v),e={},n.each(o,function(n,t){e[t.title.toLowerCase()]=t.value});u.on("preInit",function(){u.on("PreProcess SetContent",function(n){var t=u.dom;tinymce.each(t.select("span",n.node),function(n){var i=n.style.fontFamily;i&&(i=i.toLowerCase().replace(/'/g,""),i!=="serif"&&e[i]!==r&&t.setStyle(n,"fontFamily",e[i]))})})})}}),tinymce.create(u+".Fright",{Fright:function(t){if(t.getParam("frightMode")!=!0)return!1;n.extend(this,t);var u=this,i=this.getEditor(),r="mce-top-right-body";i.on("postrender",function(t){function e(){var i="mce-first",t="mce-last";f.each(function(){n(this).removeClass(i).removeClass(t)}).first().addClass(i).end().last().addClass(t).end()}var s=n(t.target.contentAreaContainer).prev(),f=u.getButtonsByProperty("xenfright",null,s),c=s.find(".mce-toolbar").first(),o,h;if(i.addCommand("resetFright",e),!f.length>0)return!1;f.click(function(){setTimeout(function(){e()},0)}),e(),o=n('<div id="mce-top-right" class="mce-container mce-flow-layout-item mce-btn-group" role="toolbar" />'),h=n('<div id="'+r+'" />').append(f),h.prependTo(o),o.prependTo(c);i.on("FullscreenStateChanged",function(){e()})})}}),tinymce.create(u+".Modal",{Modal:function(t){ed.on("XenModalComplete",function(i){function l(){h.children(".mce-container-body").addClass("mainBodyOverflow")}var s=i.modal,f=i.args,u=i.params,h=n(s.getEl()),e=!1,o=h.find(".noResponsive").length?!0:!1,c="mce-charmap";h.find("."+c).length>=1&&(e="modal-"+c,l()),u&&u.disableResponsive!==r&&(o=u.disableResponsive),f&&f.disableResponsive!==r&&(o=f.disableResponsive),(t.isOldXen===!0||t.getParam("disableResponsive"))&&(o=!0),o||t.responsiveModal(s),f&&f.modalClassName!==r&&(e=f.modalClassName),u&&u.modalClassName!==r&&(e=u.modalClassName),e&&s.addClass(e)})}}),tinymce.create(u+".quirks",{quirks:function(t){var i=t.getEditor(),u="InlineMessageEditor",r;i.on("postrender",function(t){$container=n(i.getContainer()),$container.parents("form").hasClass(u)&&tinyMCE.activeEditor.execCommand("mceAutoResize",!1,t)});i.on("BeforeSetContent",function(r){function f(n){var t=/^(?:[\s]+)?<img[^>]*?\/>(?:[\s]+)?$/;return t.test(n)}function e(n){var t=/(class="[^"]+?(?="))/;return n=t.test(n)?n.replace(t,"$1 "+u):n.replace(/(<img)/,'$1 class="'+u+'" ')}if(t.getParam("extendInsert")){var u="tmp_"+(+new Date).toString(16);f(r.content)&&(r.content=e(r.content));i.on("ExecCommand",function(t){var a=t.command,s,e;if(a=="mceInsertContent"){var c=i.selection.getBookmark(),r=n(i.getBody()),h=r.find("#"+c.id+"_start"),l=h.offset().top,o=r.parent().add(r);if(i.selection.moveToBookmark(c),h.length)if(s=t.value,e={skip_focus:!0},f(s))r.find("img."+u).one("load",function(t){i.execCommand("mceAutoResize",!1,t,e);var r=n(this),s=r.offset(),f=s.top+r.height();r.removeClass(u),o.scrollTop(f)});else o.scrollTop(l),i.execCommand("mceAutoResize",!1,t,e)}})}});if(!t.isOldXen)return!1;i.on("postrender",function(){var r=i.getDoc();if($form=n(i.getContainer()).parents("form"),!tinymce.isIE&&$form.hasClass(u))try{i.settings.readonly||(r.designMode="On")}catch(f){}});t.getParam("geckoFullfix")&&(r=XenForo._overlayConfig.onBeforeLoad,XenForo._overlayConfig.onBeforeLoad=function(t){if(window.tinyMCE&&tinymce.isGecko&&n(this.getTrigger()).hasClass("edit")&&($mceTextarea=n(tinyMCE.activeEditor.getElement()),!$mceTextarea.attr("disabled"))){var i=$mceTextarea.attr("id");tinyMCE.execCommand("mceRemoveEditor",!1,i),tinyMCE.execCommand("mceAddEditor",!0,i),tinyMCE.activeEditor.focus()}typeof r=="function"&&r(t)})}}),tinymce.create(u+".TableIntegration",{TableIntegration:function(t){function u(t,u){var e=i.dom,f;(f=i.dom.getParent(i.selection.getStart(),"table"),f!=r)&&($tableElm=n(f),$tableElm.attr("data-skin","skin"+u))}function f(t){var e=i.dom,f,u;if((f=i.dom.getParent(i.selection.getStart(),"table"),$skins=n(t.control.getEl()).find(".mce-text"),$skins.css("font-weight","normal"),f!=r)&&($tableElm=n(f),u=$tableElm.attr("data-skin"),u!=r)){if(u=parseInt(u.replace("skin","")),isNaN(u)||u>4)return!1;$skins.eq(u-1).css("font-weight","bold")}}this.ed=t.getEditor();var e=this,i=this.ed;i.addMenuItem("xen_tableskin",{name:"xen_tableskin",text:"Table skins",context:"table",onShow:f,menu:[{text:"Skin 1",onclick:function(n){u(n,1)}},{text:"Skin 2",onclick:function(n){u(n,2)}},{text:"Skin 3",onclick:function(n){u(n,3)}},{text:"Skin 4",onclick:function(n){u(n,4)}}]})}}),tinymce.create(u+".Fullscreen",{Fullscreen:function(t){var i=t.getEditor(),u;if(i.buttons.fullscreen===r)return!1;if(tinymce.isIE&&tinymce.Env.ie<=7)return delete i.buttons.fullscreen,!1;u=i.buttons.fullscreen,u.xenfright=!0;i.on("submit",function(){t.isFullscreen()&&i.execCommand("mceFullScreen")});i.on("FullscreenStateChanged",function(t){$container=n(i.getContainer()),n(t.target.contentDocument).find("html").css("overflow","auto"),t.state==!1&&(n("html, body").animate({scrollTop:$container.offset().top},300),i.focus())})}}),tinymce.create(u+".XenLink",{XenLink:function(t){n.extend(this,t),this.ed=this.getEditor();var f=this,i=this.ed,r={},u={};r={name:"xen_link",icon:"link",shortcut:"Ctrl+K",stateSelector:"a[href]",onclick:n.proxy(this,"init")},u={type:"splitbutton",menu:f.buildMenuItems(xenMCE.Phrases.unlink),onshow:function(){n(".mce-tooltip:visible").hide()},onselect:function(){i.execCommand("unlink")}},t.getParam("fastUnlink")&&n.extend(r,u),i.addButton("xen_link",r),i.addButton("xen_unlink",{name:"xen_unlink",icon:"unlink",cmd:"unlink",stateSelector:"a[href]"}),i.addMenuItem("xen_link",{name:"xen_link",icon:"link",shortcut:"Ctrl+K",stateSelector:"a[href]",onclick:n.proxy(this,"init"),text:xenMCE.Phrases.xen_link_desc,context:"insert",prependToContext:!0})},init:function(){var t=this.getParam("overlayLinkSize");config={width:t.w,height:t.h,onsubmit:this.submit},this.loadOverlay("link",config)},submit:function(n,t,i,r){xenMCE.Templates.Link.submit(n,t,i,r)}}),tinymce.create(u+".XenColors",{XenColors:function(t){function u(i){var u=i.panel.html,r=i.selectcmd,e=i.onclick;t.getParam("extraColors")==!0&&(i.panel.html=function(){var t='<div href="#" class="mceAdvPicker" data-mode="'+r+'">';return t+=xenMCE.Phrases.more_colors,t+="</div>",u()+t}),i.onshow=function(){var i=this;n(".mceAdvPicker").unbind("click").bind("click",function(t){t.preventDefault(),i.hidePanel();var r={mode:n(this).data("mode"),buttonCtrl:i};f.init(r)}),f.fixBtnFullscreen(i,"panel")}}n.extend(this,t);var f=this,i=this.ed=this.getEditor(),e;i.buttons.forecolor!==r&&u(i.buttons.forecolor),i.buttons.backcolor!==r&&u(i.buttons.backcolor)},init:function(t){this._colorButton=t;var i=this.getParam("overlayColorPickerSize");config={width:i.w,height:i.h,onsubmit:n.proxy(this,"submit")},callbacks={src:this,onafterload:"onafterload"},this.loadOverlay("colors",config,callbacks)},onafterload:function(n,t,i,r){xenMCE.Templates.ColorPicker.init(n,t,i,r)},submit:function(n,t,i,r){r=this,xenMCE.Templates.ColorPicker.submit(n,t,i,r)}}),tinymce.create(u+".XenMedia",{XenMedia:function(t){n.extend(this,t),this.ed=this.getEditor();var r=this,i=this.ed;i.addButton("xen_media",{name:"xen_media",icon:"media",onclick:n.proxy(this,"init")})},init:function(){var t=this.getParam("overlayMediaSize");config={width:t.w,height:t.h,onsubmit:this.submit},this.loadOverlay("media",config)},submit:function(n,t,i,r){xenMCE.Templates.Media.submit(n,t,i,r)}}),tinymce.create(u+".XenImage",{XenImage:function(t){n.extend(this,t),this.ed=this.getEditor();var r=this,i=this.ed;i.addButton("xen_image",{name:"xen_image",icon:"image",stateSelector:"img:not([data-mce-object],[data-smilie])",onclick:n.proxy(this,"init")})},init:function(){var i=this.ed.selection.getNode(),t=this.getParam("overlayImageSize");config={width:t.w,height:t.h,onsubmit:this.submit},i.nodeName=="IMG"&&(config.data={url:this.ed.dom.getAttrib(i,"src")}),this.loadOverlay("image",config)},submit:function(n,t,i,r){xenMCE.Templates.Image.submit(n,t,i,r)}}),tinymce.create(u+".XenCode",{XenCode:function(t){n.extend(this,t),this.ed=this.getEditor();var u=this,r=this.ed,i="xen_code";r.addButton(i,{name:i,icon:i,iconset:"xenforo",onclick:n.proxy(this,"init")})},init:function(){config={width:480,height:300,onsubmit:this.submit},this.loadOverlay("code",config)},submit:function(n,t,i,r){xenMCE.Templates.Code.submit(n,t,i,r)}}),tinymce.create(u+".XenQuote",{XenQuote:function(n){var i=n.getEditor(),t="xen_quote";i.buttons[t]===r&&i.addButton(t,{name:t,icon:t,iconset:"xenforo",onclick:function(){n.insertBbCode("quote",!1)}})}}),tinymce.create(u+".XenSmilies",{XenSmilies:function(t){function s(n){function e(n,r){return tinymce.each(r,function(r,u){var c=i.dom,f={id:r[1],desc:r[0],bbcode:c.encode(u)},e=t.getParam("smiliesDesc");if(e=="bbcode"?f.desc=u:e=="none"&&(f.desc=""),s!=0&&l>s)return!1;n+=typeof f.id=="number"?'<a href="#"><img src="styles/default/xenforo/clear.png" alt="'+f.bbcode+'" title="'+f.desc+'" '+h+' class="'+o+" "+o+"Sprite mceSmilie"+f.id+'"  /></a>':'<a href="#"><img src="'+c.encode(f.id)+'" alt="'+f.bbcode+'" title="'+f.desc+'" '+h+' class="'+o+'" /></a>',l++}),n}var l=1,s,o="mceQuattroSmilie",a="",f=t.getParam("xenforo_smilies"),v=t.getParam("smiliesCat"),c=t.getParam("xCatSmilies"),u,h;return n===!0?(s=0,a="Full"):s=t.getParam("xSmilies"),u='<div role="presentation" class="'+o+"Block"+a+' responsiveBlock">',h='data-smilie="yes"',v?n!==!0&&c!=-1&&f[c]!==r?u+=e("",f[c].smilies):tinymce.each(f,function(t){n===!0?(u+='<p class="mce_smilie_cat_title">'+t.title+"</p>",u+='<div class="mce_smilie_cat">'+e("",t.smilies)+"</div>"):u+=e("",t.smilies)}):u=e(u,f),u+="</div>"}function l(){return s()}function e(){var u=s(!0),r={type:"container",html:u,onclick:function(t){var r,u;t.preventDefault(),r=i.dom.getParent(t.target,"a"),r&&(u=n(r).html(),i.execCommand("mceInsertContent",!1,u))}},t=i.windowManager.open({title:"Smilies picker",spacing:10,padding:10,items:[r],buttons:[{text:"Close",onclick:function(){t.close()}}]},{modalClassName:"modal-smilies"})}var u;n.extend(this,t);var h=this,i=this.getEditor(),o="xen_smilies",f="xen_smilies_picker",c=t.getParam("smiliesWindow");i.addButton(o,{name:o,icon:"emoticons",type:"panelbutton",stateSelector:"img[data-smilie]",popoverAlign:"bc-tl",panel:{autohide:!0,html:l,onclick:function(t){var u=i.dom.getParent(t.target,"a"),r;u&&(r=n(u).html(),i.execCommand("mceInsertContent",!1,r),this.hide())}}}),u={name:f,icon:f,iconset:"xenforo",tooltip:"Smilies picker",stateSelector:"img[data-smilie]"},u.onclick=c=="slider"?n.proxy(this,"initOvl"):c!="belowbox"||this.isOldXen?e:function(n){h.isFullscreen()?e():h.initBox(this,n,i)},i.addButton(f,u)},initOvl:function(){var t=this.getParam("overlaySmiliesSize");config={width:parseInt(t.w),height:parseInt(t.h)},callbacks={src:this,onafterload:"onafterload"},this.loadOverlay("smilies_slider",config,callbacks)},onafterload:function(n,t,i,r){xenMCE.Templates.SmiliesSlider.init(n,t,i,r)},initBox:function(t,i,r){var f=this,e=n(r.getContainer()).parent(),u=e.find(".redactor_smilies");if(u.length){u.slideToggle("slow",function(){t.active(u.is(":visible"))});return}f.smiliesPending||(f.smiliesPending=!0,XenForo.ajax("index.php?editor/smilies",{mce:"mce4"},function(t){XenForo.hasResponseError(t)||t.templateHtml&&new XenForo.ExtLoader(t,function(){u=n('<div class="redactor_smilies mce" />').html(t.templateHtml),u.hide();u.on("click",".Smilie",function(t){t.preventDefault();var u=n(this),i=n.trim(u.html());r.execCommand("mceInsertContent",!1,i),r.focus()});e.append(u),u.slideToggle()})}).complete(function(){f.smiliesPending=!1,t.active(!0)}))}}),tinymce.create(u+".XenNonBreaking",{XenNonBreaking:function(n){var t=n.getEditor(),r="xen_nonbreaking",i="XenNonBreaking";if(t.addCommand(i,function(){t.insertContent(t.plugins.visualchars&&t.plugins.visualchars.state?'<span data-mce-bogus="1" class="mce-nbsp">&nbsp;</span>':"&nbsp;")}),t.addButton(r,{name:r,cmd:i}),t.getParam("nonbreaking_force_tab"))t.on("keydown",function(n){if(n.keyCode==9){n.preventDefault();for(var r=0;r<4;)t.execCommand(i),r++}})}}),tinymce.create(u+".XenDraft",{XenDraft:function(n){var u,f;if(n.isOldXen)return!1;this.ed=n.getEditor(),this.draftText=xenMCE.Phrases.draft,this.$textarea=n.$textarea,this.autoSaveUrl=this.$textarea.data("auto-save-url");var t=this,i=this.ed,o={},e="Draft mode: ",r="restoredraft";if(!this.autoSaveUrl||!n.getParam("xendraft")){console.info(e+"Mce");return}console.info(e+"Xen"),u=n.buildMenuItems(t.draftText.save+"|"+t.draftText._delete,"saveDraft|deleteDraft",null,"xen_draft"),f=function(n){t.saveDraft(!0,n.control.settings.value=="deleteDraft")};i.on("BeforeRenderUI",function(){if(!n.isActiveButton(r))return!1});i.addButton(r,{name:r,title:t.draftText.save,type:"menubutton",menu:u,onselect:f});i.on("init",function(){t.pathEl=n.getPathEl(!0),t.initAutoSave()});i.addCommand("xenDraftSave",function(){t.saveDraft(!0)}),i.addCommand("xenDraftDelete",function(){t.saveDraft(!0,!0)})},initAutoSave:function(){var t=this,f=n(this.ed.getContainer()).parents("form"),r=t.$textarea.data("options"),u=this.ed.getContent(),i;f.length&&(this.lastAutoSaveContent=u,i=setInterval(function(){if(!t.$textarea.data("mce4")){clearInterval(i);return}t.saveDraft()},(r.autoSaveFrequency||60)*1e3))},saveDraft:function(t,i){var u=this,e=n(this.ed.getContainer()).parents("form"),s=this.ed.windowManager,o={content:this.ed.getContent()},f="",r;return(this.ed.fire("SavingXenDraft",o),f=o.content,!i&&!t&&f==this.lastAutoSaveContent)?!1:(this.lastAutoSaveContent=f,r=n.Event("BbCodeWysiwygEditorAutoSave"),r.editor=this,r.content=f,r.deleteDraft=i,e.trigger(r),r.isDefaultPrevented())?!1:this.autoSaveRunning?!1:(this.autoSaveRunning=!0,XenForo.ajax(this.autoSaveUrl,e.serialize()+(i?"&delete_draft=1":""),function(r){var o=n.Event("BbCodeWysiwygEditorAutoSaveComplete"),f;if(o.ajaxData=r,e.trigger(o),!o.isDefaultPrevented()){if(r.draftSaved?f=u.draftText.saved:r.draftDeleted&&(f=u.draftText.deleted),!f)return;if(t||i){s.alert(f);return}if(u.pathEl==!1){console.log(u.draftText.saved);return}$path=u.pathEl,n('<div class="draftNotice"><span>'+f+"</span></div>").insertAfter($path).css({display:"inline-block",padding:"8px"}).finish().hide().fadeIn().delay(2e3).fadeOut()}},{global:!1}).complete(function(){u.autoSaveRunning=!1}),!0)}}),tinymce.create(u+".XenIcons",{XenIcons:function(t){function u(n){i.buttons[n].type!==r&&(i.buttons[n].type="button")}var i=t.getEditor(),f=xenMCE.Phrases;i.on("BeforeRenderUI",function(){function u(n){i.menuItems[n]!==r&&delete i.menuItems[n]}if(t.isActiveButton("xen_link")||u("xen_link"),!t.isActiveButton("table")){var f=["inserttable","xen_tableskin","cell","row","column","deletetable"];tinymce.each(f,function(n){u(n)})}});tinymce.each(i.buttons,function(n,t){var u=t+"_desc";XenForo.isTouchBrowser()?i.buttons[t].tooltip!==r&&delete i.buttons[t].tooltip:f[u]!==r&&(i.buttons[t].tooltip=f[u])}),t.getParam("extraLists")!=!0&&(u("bullist"),u("numlist"));i.on("init",function(){$buttons=t.getButtonsByProperty("iconset","xenforo",!0),$buttons.find("i.mce-ico").addClass("mce-xenforo-icons");var u=i.theme.panel.find("#statusbar");u&&u.length>0&&($statBar=n(u[0].getEl())),t.getParam("hidePath")&&u.length>0&&$statBar.find(".mce-path").css("visibility","hidden")})}})})(jQuery,this,document);