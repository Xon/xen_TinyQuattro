!function(a,b,c,d){tinymce.create("tinymce.plugins.xen_tagging",{init:function(b){if(xenMCE.Lib.getTools().getParam("oldXen"))return!1;this.editor=b;var d=this;b.on("PastePreProcess",function(a){a.content=a.content.replace(/(.|^)<a\s[^>]*data-user="(\d+, [^"]+)"[^>]*>([\w\W]+?)<\/a>/gim,function(a,b,c,d){var e=c.split(", ");return parseInt(e[0],10)?b+("@"==b?"":"@")+e[1].replace(/^@/,""):a})}),b.on("init",function(c){var e=a(b.getElement()),f=a(b.getBody()),g=e.data("ac-url")||XenForo.AutoComplete.getDefaultUrl();d.$textarea=e,d.$ed=f,d.autoCompleteUrl=g;var h=f.get(0).ownerDocument,i=function(){setTimeout(function(){d.acResults.hideResults()},200)};d.acVisible=!1,d.acResults=new XenForo.AutoCompleteResults({onInsert:a.proxy(d,"insert")}),a(h.defaultView||h.parentWindow).on("scroll",i),f.on("click blur",i),b.on("keydown",function(a){var b=d.acResults,c=!0;if(b.isVisible()){switch(a.keyCode){case 40:b.selectResult(1);break;case 38:b.selectResult(-1);break;case 27:b.hideResults();break;case 13:b.insertSelectedResult();break;default:c=!1}c&&(a.stopPropagation(),a.stopImmediatePropagation(),a.preventDefault())}}),b.on("keyup",function(a){var b=d.acResults,c=!1;if(b.isVisible())switch(a.keyCode){case 40:case 38:case 27:case 13:c=!0}if(!c){var e=d.getAfterAt();e?d.trigger(e):b.hideResults()}c&&(a.stopPropagation(),a.stopImmediatePropagation(),a.preventDefault())})})},getAfterAt:function(){return this.parseCurrentLine()},insert:function(b){if(!this.range)return void console.alert("Range is missing");var h,i,c=this.editor,f=(c.selection.getEnd(),this.range),g=f.endContainer;if(1==g.nodeType&&tinymce.isIE&&tinymce.Env.ie<=9)h=a(g).contents().filter(function(){return 3==this.nodeType}).text();else{if(3!=g.nodeType)return!1;h=g.nodeValue}if(typeof h===d)return!1;i=h.lastIndexOf("@"),f.setStart(g,i),c.selection.setRng(this.range);var j="@"+XenForo.htmlspecialchars(b)+"&nbsp;";return c.execCommand("mceInsertContent",!1,j),c.nodeChanged(),this.lastAcLookup=b+" ",!1},trigger:function(b){b=b.replace(new RegExp(String.fromCharCode(160),"g")," "),this.lastAcLookup&&this.lastAcLookup==b||(this.lastAcLookup=b,b.length>2&&"["!=b.substr(0,1)&&(this.acLoadTimer=setTimeout(a.proxy(this,"lookup"),200)))},lookup:function(){this.acXhr&&this.acXhr.abort(),this.acXhr=XenForo.ajax(this.autoCompleteUrl,{q:this.lastAcLookup},a.proxy(this,"showResults"),{global:!1,error:!1})},showResults:function(b){this.acXhr=!1,this.bookmark=!1;var c=this.editor;$iframe=a(c.getContainer()).find("iframe"),$iframeBody=a(c.getBody());var e=c.selection.getBookmark();$bm=$iframeBody.find("#"+e.id+"_start");var f=function(){$bm.remove()},i=($bm.parent().get(0),$bm.get(0),$bm.get(0).previousSibling);if(typeof i===d||null===i)return f(),!1;var j=i.nodeValue;if(typeof j===d||null===j)return f(),!1;var k=j.lastIndexOf("@");if(-1==k)return f(),!1;var m=(i.splitText(k),$iframe.offset()),n=$bm.offset(),o={top:m.top+n.top+$bm.parent().height(),left:m.left+n.left};f(),this.acResults.showResults(this.lastAcLookup,b.results,$iframe,o)},hide:function(){this.acResults.hideResults(),this.acLoadTimer&&(clearTimeout(this.acLoadTimer),this.acLoadTimer=!1)},parseCurrentLine:function(){this.range=!1;var f,g,h,a=this.editor,b=a.selection.getRng(!0).cloneRange(),c=b.endContainer;b.endContainer.previousSibling;return 3==c.nodeType&&(typeof(f=c.nodeValue)!==d&&(!(-1==(g=f.lastIndexOf("@"))||0!=g&&!f.substr(g-1,1).match(/(\s|[\](,]|--)/))&&(h=f.substr(g+1),!(h.match(/\s/)||h.length>10||h.length<2)&&(this.range=b,h))))}}),tinymce.PluginManager.add("xen_tagging",tinymce.plugins.xen_tagging)}(jQuery,0,document,"undefined");