!function(n,t,i,r){tinymce.create("tinymce.plugins.xen_tagging",{init:function(t){var r=xenMCE.Lib.getTools(),i;if(r.getParam("oldXen"))return!1;this.editor=t,i=this;t.on("PastePreProcess",function(n){n.content=n.content.replace(/(.|^)?<a\s[^>]*data-user="(\d+, [^"]+)"[^>]*>([\w\W]+?)<\/a>/gi,function(n,t,i){t||(t="");var u=i.split(", ");return parseInt(u[0],10)?t+(t=="@"?"":"@")+u[1].replace(/^@/,""):n})});t.on("init",function(){var o=n(t.getElement()),u=n(t.getBody()),s=o.data("ac-url")||XenForo.AutoComplete.getDefaultUrl(),f,e;i.$textarea=o,i.$ed=u,i.autoCompleteUrl=s,f=u.get(0).ownerDocument,e=function(){setTimeout(function(){i.acResults.hideResults()},200)},i.acVisible=!1,i.acResults=new XenForo.AutoCompleteResults({onInsert:n.proxy(i,"insert")});n(f.defaultView||f.parentWindow).on("scroll",e);u.on("click blur",e);t.on("keydown",function(n){var t=i.acResults,r=!0;if(t.isVisible()){switch(n.keyCode){case 40:t.selectResult(1);break;case 38:t.selectResult(-1);break;case 27:t.hideResults();break;case 13:t.insertSelectedResult();break;default:r=!1}r&&(n.stopPropagation(),n.stopImmediatePropagation(),n.preventDefault())}});t.on("keyup",function(){var t=i.getAfterAt();t?i.trigger(t):i.hide()})})},getAfterAt:function(){return this.parseCurrentLine()},insert:function(t){var s;if(!this.range){console.alert("Range is missing");return}var u=this.editor,h=u.selection.getEnd(),e=this.range,i=e.endContainer,f,o;if(i.nodeType==1&&tinymce.isIE&&tinymce.Env.ie<=9)f=n(i).contents().filter(function(){return this.nodeType==3}).text();else if(i.nodeType==3)f=i.nodeValue;else return!1;return typeof f===r?!1:(o=f.lastIndexOf("@"),e.setStart(i,o),u.selection.setRng(this.range),s="@"+XenForo.htmlspecialchars(t)+"&nbsp;",u.execCommand("mceInsertContent",!1,s),u.nodeChanged(),this.lastAcLookup=t+" ",!1)},trigger:function(t){(t=t.replace(new RegExp(String.fromCharCode(160),"g")," "),this.lastAcLookup&&this.lastAcLookup==t)||(this.hide(),this.lastAcLookup=t,t.length>2&&t.substr(0,1)!="["&&(this.acLoadTimer=setTimeout(n.proxy(this,"lookup"),200)))},lookup:function(){this.acXhr&&this.acXhr.abort(),this.acXhr=XenForo.ajax(this.autoCompleteUrl,{q:this.lastAcLookup},n.proxy(this,"showResults"),{global:!1,error:!1})},showResults:function(t){var i,s,e,o,h;this.acXhr=!1,this.bookmark=!1,i=this.editor,$iframe=n(i.getContainer()).find("iframe"),$iframeBody=n(i.getBody()),s=i.selection.getBookmark(),$bm=$iframeBody.find("#"+s.id+"_start");var u=function(){$bm.remove()},a=$bm.parent().get(0),v=$bm.get(0),f=$bm.get(0).previousSibling;if(typeof f===r||f===null||(e=f.nodeValue,typeof e===r||e===null)||(o=e.lastIndexOf("@"),o==-1))return u(),!1;h=f.splitText(o),a.insertBefore(v,h);var c=$iframe.offset(),l=$bm.offset(),y={top:c.top+l.top+$bm.parent().height(),left:c.left+l.left};u(),this.acResults.showResults(this.lastAcLookup,t.results,$iframe,y)},hide:function(){this.acResults.hideResults(),this.acLoadTimer&&(clearTimeout(this.acLoadTimer),this.acLoadTimer=!1)},parseCurrentLine:function(){this.range=!1;var e=this.editor,u=e.selection.getRng(!0).cloneRange(),f=u.endContainer,o=u.endContainer.previousSibling,n,t,i;return f.nodeType!=3?!1:(n=f.nodeValue,typeof n===r)?!1:(t=n.lastIndexOf("@"),t!=-1&&(t==0||n.substr(t-1,1).match(/(\s|[\](,]|--)/)))?(i=n.substr(t+1),i.match(/\s/)||i.length>10||i.length<2)?!1:(this.range=u,i):!1}}),tinymce.PluginManager.add("xen_tagging",tinymce.plugins.xen_tagging)}(jQuery,this,document,"undefined");