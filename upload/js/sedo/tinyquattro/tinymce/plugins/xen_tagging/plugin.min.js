tinymce.create("tinymce.plugins.xen_tagging",{init:function(n){if(xenMCE.Params.oldXen)return!1;this.editor=n;var t=this;n.on("init",function(){var e=$(n.getElement()),f=$(n.getBody()),o=e.data("ac-url")||XenForo.AutoComplete.getDefaultUrl(),r,u;t.$textarea=e,t.$ed=f,t.autoCompleteUrl=o,r=f.get(0).ownerDocument,u=function(){setTimeout(function(){t.acResults.hideResults()},200)},t.acVisible=!1,t.acResults=new XenForo.AutoCompleteResults({onInsert:$.proxy(t,"insert")});$(r.defaultView||r.parentWindow).on("scroll",u);f.on("click blur",u);n.on("keydown",function(n){var i=t.acResults,r=!0;if(i.isVisible()){switch(n.keyCode){case 40:i.selectResult(1);break;case 38:i.selectResult(-1);break;case 27:i.hideResults();break;case 13:i.insertSelectedResult();break;default:r=!1}r&&(n.stopPropagation(),n.stopImmediatePropagation(),n.preventDefault())}});n.on("keyup",function(){var i=t.getAfterAt();i?t.trigger(i):t.hide()})})},getAfterAt:function(){return this.parseCurrentLine()},insert:function(n){var u;if(!this.range){console.alert("Range is missing");return}var r=this.editor,o=r.selection.getEnd(),e=this.range,t=e.endContainer,i,f;if(t.nodeType==1&&tinymce.isIE&&tinymce.Env.ie<=9)i=$(t).contents().filter(function(){return this.nodeType==3}).text();else if(t.nodeType==3)i=t.nodeValue;else return!1;return typeof i=="undefined"?!1:(f=i.lastIndexOf("@"),e.setStart(t,f),r.selection.setRng(this.range),u="@"+XenForo.htmlspecialchars(n)+"&nbsp;",r.execCommand("mceInsertContent",!1,u),r.nodeChanged(),this.lastAcLookup=n+" ",!1)},trigger:function(n){(n=n.replace(new RegExp(String.fromCharCode(160),"g")," "),this.lastAcLookup&&this.lastAcLookup==n)||(this.hide(),this.lastAcLookup=n,n.length>2&&n.substr(0,1)!="["&&(this.acLoadTimer=setTimeout($.proxy(this,"lookup"),200)))},lookup:function(){this.acXhr&&this.acXhr.abort(),this.acXhr=XenForo.ajax(this.autoCompleteUrl,{q:this.lastAcLookup},$.proxy(this,"showResults"),{global:!1,error:!1})},showResults:function(n){var r,u,h,i,f,o;this.acXhr=!1,this.bookmark=!1,r=this.editor,u="undefined",$iframe=$(r.getContainer()).find("iframe"),$iframeBody=$(r.getBody()),h=r.selection.getBookmark(),$bm=$iframeBody.find("#"+h.id+"_start");var l=$bm.parent().get(0),a=$bm.get(0),t=$bm.get(0).previousSibling;if(typeof t===u||t===null||(i=t.nodeValue,typeof i===u||i===null)||(f=i.lastIndexOf("@"),f==-1))return!1;o=t.splitText(f),l.insertBefore(a,o);var e=$iframe.offset(),s=$bm.offset(),c={top:e.top+s.top+$bm.parent().height(),left:e.left+s.left};$bm.remove(),this.acResults.showResults(this.lastAcLookup,n.results,$iframe,c)},hide:function(){this.acResults.hideResults(),this.acLoadTimer&&(clearTimeout(this.acLoadTimer),this.acLoadTimer=!1)},parseCurrentLine:function(){this.range=!1;var f=this.editor,r=f.selection.getRng(!0).cloneRange(),u=r.endContainer,e=r.endContainer.previousSibling,n,t,i;return u.nodeType!=3?!1:(n=u.nodeValue,typeof n=="undefined")?!1:(t=n.lastIndexOf("@"),t!=-1&&(t==0||n.substr(t-1,1).match(/(\s|[\](,]|--)/)))?(i=n.substr(t+1),i.match(/\s/)||i.length>10||i.length<2)?!1:(this.range=r,i):!1}}),tinymce.PluginManager.add("xen_tagging",tinymce.plugins.xen_tagging);