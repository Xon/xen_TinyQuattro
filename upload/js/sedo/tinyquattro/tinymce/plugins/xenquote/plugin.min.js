(function(n,t,i,r){tinymce.PluginManager.add("xenquote",function(t){var o=xenMCE.Lib.getTools(),u="data-mcequote",a=/\[quote(?:=(.*?))?\]([\s\S]*?)\[\/quote\]/g,c=/^<blockquote.*?data-mcequote[\s\S]*?<\/blockquote>$/,s=tinymce.isIE?"<p>&nbsp;</p>":"<p><br /></p>",l=function(t,i){var s=n('<blockquote class="mce_quote" '+u+'="true" />'),a=t[0],f=t[1],e=t[2],l="",v=/^<p>/g,c,h;return!e||e==r?!1:(v.test(e)||(e="<p>"+e+"</p>"),s.html(e),f!=r&&(f=o.unescapeHtml(f),f=f.substring(1,f.length-1),f=f.split(","),n.isArray(f)&&(c=f.shift(),h=[],c&&s.attr("data-username",c),n.each(f,function(t,i){var e=i.split(":",2),u,f;e[1]!=r&&(u=n.trim(e[0]),f=n.trim(e[1]),u!==""&&f!==""&&(h.push(u),s.attr("data-"+u,f)))}),h.length!=0&&s.attr("data-attributes",h.toString()))),l=s.wrap("<div />").parent().append("<p />").html(),i.replace(a,l))};t.on("BeforeExecCommand",function(i){var e,f;if(n.inArray(i.command,["insertHtml","mceInsertContent"])!==-1){if(e=a.exec(i.value),e)return f=l(e,i.value),f&&t.execCommand(i.command,!1,f),!1;if(c.test(i.value))return t.execCommand(i.command,!1,i.value+s),!1}});var i="xen_quote",f=function(n){var i=t.selection.getNode(),u=t.dom;return(i.tagName!="BLOCKQUOTE"&&(i=u.getParent(i,"blockquote")),i==r||!i)?!1:n!=r?u.getAttrib(i,n)?i:!1:i},h=function(n,i,u,f){var s=tinymce.each,l=tinymce.inArray,e=[{type:"textbox",name:"username",label:"Username",value:i||""}],c=["data-username","class","data-mcequote","data-attributes"],a=[],h=!0;h&&s(u,function(n){var t=n.name,i=n.value;l(c,t)===-1&&t!=r&&(t=t.replace(/data-/i,""),e.push({type:"textbox",name:t,label:o.getPhrase("field")+' "'+t+'"',value:i||""}))}),t.windowManager.open({title:"Quote properties",body:e,onsubmit:function(t){var i=t.data;s(i,function(t,i){f.setAttrib(n,"data-"+i,t)})}})},e={name:i,icon:i,iconset:"xenforo",type:"splitbutton",menu:[{value:"setProperties",text:"Quote properties",onclick:function(n){var i;if(n.stopPropagation(),i=f(u),!i)return!1;var c=n.control,s=n.control._value,r=t.dom,o=r.getAttribs(i),e=r.getAttrib(i,"data-username");s=="setProperties"&&h(i,e,o,r)}}],onshow:function(){n(".mce-tooltip:visible").hide();var i=f(u);this.menu._items.disabled(!i)},onclick:function(n){var i,u,e;if(n.stopPropagation(),t.execCommand("mceBlockQuote"),i=f(),u=t.dom,i==r)return!1;e=u.getAttribs(i,"data-mcequote"),e.length||u.setAttribs(i,{"class":"mce_quote","data-mcequote":"true"})},onPostRender:function(){var i=this;if(t.formatter)t.formatter.formatChanged("blockquote",function(n){i.active(n)});else t.on("init",function(){t.formatter.formatChanged("blockquote",function(n){i.active(n)})})}};t.addButton(i,e),t.addMenuItem(i,n.extend({},e,{text:"Quote",type:"menuitem"}))})})(jQuery,this,document);