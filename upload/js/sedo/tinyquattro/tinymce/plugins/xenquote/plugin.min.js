(function(n,t,i,r){tinymce.PluginManager.add("xenquote",function(t){var c=xenMCE.Lib.getTools(),h=xenMCE.Phrases,i="data-mcequote",a=/\[quote(?:=(.*?))?\]([\s\S]*?)\[\/quote\]/g,l=/^<blockquote.*?data-mcequote[\s\S]*?<\/blockquote>$/,s=tinymce.isIE?"<p>&nbsp;</p>":"<p><br /></p>",e=function(t,u){var o=n('<blockquote class="mce_quote" '+i+'="true" />'),a=t[0],f=t[1],e=t[2],l="",v=/^<p>/g,h,s;return!e||e==r?!1:(v.test(e)||(e="<p>"+e+"</p>"),o.html(e),f!=r&&(f=c.unescapeHtml(f),f=f.substring(1,f.length-1),f=f.split(","),n.isArray(f)&&(h=f.shift(),s=[],h&&o.attr("data-username",h),n.each(f,function(t,i){var e=i.split(":",2),u,f;e[1]!=r&&(u=n.trim(e[0]),f=n.trim(e[1]),u!==""&&f!==""&&(s.push(u),o.attr("data-"+u,f)))}),s.length!=0&&o.attr("data-attributes",s.toString()))),l=o.wrap("<div />").parent().append("<p />").html(),u.replace(a,l))};t.on("BeforeExecCommand",function(i){var o,f;if(n.inArray(i.command,["insertHtml","mceInsertContent"])!==-1){if(o=a.exec(i.value),o)return f=e(o,i.value),f&&t.execCommand(i.command,!1,f),!1;if(l.test(i.value))return t.execCommand(i.command,!1,i.value+s),!1}});var u="xen_quote",f=function(n){var i=t.selection.getNode(),u=t.dom;return(i.tagName!="BLOCKQUOTE"&&(i=u.getParent(i,"blockquote")),i==r||!i)?!1:n!=r?u.getAttrib(i,n)?i:!1:i},o=function(n,i,u,f){var o=tinymce.each,l=tinymce.inArray,e=[{type:"textbox",name:"username",label:"Username",value:i||""}],c=["data-username","class","data-mcequote","data-attributes"],a=[],s=!0;s&&o(u,function(n){var t=n.name,i=n.value;l(c,t)===-1&&t!=r&&(t=t.replace(/data-/i,""),e.push({type:"textbox",name:t,label:h.field+' "'+t+'"',value:i||""}))}),t.windowManager.open({title:"Quote properties",body:e,onsubmit:function(t){var i=t.data;o(i,function(t,i){f.setAttrib(n,"data-"+i,t)})}})};t.addButton(u,{name:u,icon:u,iconset:"xenforo",type:"splitbutton",menu:[{value:"setProperties",text:"Quote properties"}],onshow:function(){n(".mce-tooltip:visible").hide();var r=f(i);this.menu._items.disabled(!r)},onselect:function(n){var r=f(i);if(!r)return!1;var c=n.control,h=n.control._value,u=t.dom,s=u.getAttribs(r),e=u.getAttrib(r,"data-username");h=="setProperties"&&o(r,e,s,u)},onclick:function(){var i,u,e;if(t.execCommand("mceBlockQuote"),i=f(),u=t.dom,i==r)return!1;e=u.getAttribs(i,"data-mcequote"),e.length||u.setAttribs(i,{"class":"mce_quote","data-mcequote":"true"})},onPostRender:function(){var i=this;if(t.formatter)t.formatter.formatChanged("blockquote",function(n){i.active(n)});else t.on("init",function(){t.formatter.formatChanged("blockquote",function(n){i.active(n)})})}})})})(jQuery,this,document);