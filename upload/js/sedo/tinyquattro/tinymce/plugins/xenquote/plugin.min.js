(function(n,t,i,r){tinymce.PluginManager.add("xenquote",function(t){var f=xenMCE.Lib.getTools(),s=xenMCE.Phrases,h=/\[quote(?:=(.*?))?\]([\s\S]*?)\[\/quote\]/g,c=/^<blockquote.*?data-mcequote[\s\S]*?<\/blockquote>$/,o=function(t,i){var o=n('<blockquote class="mce_quote" data-mcequote="true" />'),l=t[0],u=t[1],e=t[2],c="",a=/^<p>/g,h,s;return!e||e==r?!1:(console.log(e),a.test(e)||(e="<p>"+e+"</p>"),o.html(e),u!=r&&(u=f.unescapeHtml(u),u=u.substring(1,u.length-1),u=f.escapeHtml(u),u=u.split(","),n.isArray(u)&&(h=u.shift(),s=[],h&&o.attr("data-username",h),n.each(u,function(t,i){var e=i.split(":",2),u,f;e[1]!=r&&(u=n.trim(e[0]),f=n.trim(e[1]),u!==""&&f!==""&&(s.push(u),o.attr("data-"+u,f)))}),s.length!=0&&o.attr("data-attributes",s.toString()))),c=o.wrap("<div />").parent().append("<p />").html(),i.replace(l,c))};t.on("BeforeExecCommand",function(i){var e,f,s;if(n.inArray(i.command,["insertHtml","mceInsertContent"])!==-1){if(e=h.exec(i.value),e)return f=o(e,i.value),f&&t.execCommand(i.command,!1,f),!1;if(c.test(i.value))return s=tinymce.isIE?"<p>&nbsp;</p>":"<p><br /></p>",t.execCommand(i.command,!1,i.value+s),!1}});var u="xen_quote",i=function(){var n=t.selection.getNode(),i=t.dom;return(n.tagName!="BLOCKQUOTE"&&(n=i.getParent(n,"blockquote")),n==r||!n)?!1:n},e=function(n,i,u,f){var o=tinymce.each,l=tinymce.inArray,e=[{type:"textbox",name:"username",label:"Username",value:i||""}],c=["data-username","class","data-mcequote","data-attributes"],a=[],h=!0;h&&o(u,function(n){var t=n.name,i=n.value;l(c,t)===-1&&t!=r&&(t=t.replace(/data-/i,""),e.push({type:"textbox",name:t,label:s.field+' "'+t+'"',value:i||""}))}),t.windowManager.open({title:"Quote properties",body:e,onsubmit:function(t){var i=t.data;o(i,function(t,i){f.setAttrib(n,"data-"+i,t)})}})};t.addButton(u,{name:u,icon:u,iconset:"xenforo",type:"splitbutton",menu:[{value:"setProperties",text:"Quote properties"}],onshow:function(){n(".mce-tooltip:visible").hide();var r=i();this.menu._items.disabled(!r)},onselect:function(n){var h=n.control,s=n.control._value,r=i(),u=t.dom,f=u.getAttribs(r),o=u.getAttrib(r,"data-username");s=="setProperties"&&e(r,o,f,u)},onclick:function(){var u,f,e;if(t.execCommand("mceBlockQuote"),u=i(),f=t.dom,u==r)return!1;e=f.getAttribs(u,"data-mcequote"),e.length||f.setAttribs(u,{"class":"mce_quote","data-mcequote":"true"})},onPostRender:function(){var i=this;if(t.formatter)t.formatter.formatChanged("blockquote",function(n){i.active(n)});else t.on("init",function(){t.formatter.formatChanged("blockquote",function(n){i.active(n)})})}})})})(jQuery,this,document);