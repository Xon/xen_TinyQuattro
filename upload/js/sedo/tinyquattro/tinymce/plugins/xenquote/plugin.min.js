(function(n,t,i,r){tinymce.PluginManager.add("xenquote",function(t){var s=xenMCE.Lib.getTools(),o=xenMCE.Phrases,c=/\[quote(?:=(.*?))?\]([\s\S]*?)\[\/quote\]/g,h=/^<blockquote.*?data-mcequote[\s\S]*?<\/blockquote>$/,f=function(t,i){var e=n('<blockquote class="mce_quote" data-mcequote="true" />'),l=t[0],u=t[1],f=t[2],c="",a=/^<p>/g,h,o;return!f||f==r?!1:(a.test(f)||(f="<p>"+f+"</p>"),e.html(f),u!=r&&(u=s.unescapeHtml(u),u=u.substring(1,u.length-1),u=u.split(","),n.isArray(u)&&(h=u.shift(),o=[],h&&e.attr("data-username",h),n.each(u,function(t,i){var s=i.split(":",2),u,f;s[1]!=r&&(u=n.trim(s[0]),f=n.trim(s[1]),u!==""&&f!==""&&(o.push(u),e.attr("data-"+u,f)))}),o.length!=0&&e.attr("data-attributes",o.toString()))),c=e.wrap("<div />").parent().append("<p />").html(),i.replace(l,c))};t.on("BeforeExecCommand",function(i){var o,e,s;if(n.inArray(i.command,["insertHtml","mceInsertContent"])!==-1){if(o=c.exec(i.value),o)return e=f(o,i.value),e&&t.execCommand(i.command,!1,e),!1;if(h.test(i.value))return s=tinymce.isIE?"<p>&nbsp;</p>":"<p><br /></p>",t.execCommand(i.command,!1,i.value+s),!1}});var i="xen_quote",u=function(){var n=t.selection.getNode(),i=t.dom;return(n.tagName!="BLOCKQUOTE"&&(n=i.getParent(n,"blockquote")),n==r||!n)?!1:n},e=function(n,i,u,f){var s=tinymce.each,l=tinymce.inArray,e=[{type:"textbox",name:"username",label:"Username",value:i||""}],c=["data-username","class","data-mcequote","data-attributes"],a=[],h=!0;h&&s(u,function(n){var t=n.name,i=n.value;l(c,t)===-1&&t!=r&&(t=t.replace(/data-/i,""),e.push({type:"textbox",name:t,label:o.field+' "'+t+'"',value:i||""}))}),t.windowManager.open({title:"Quote properties",body:e,onsubmit:function(t){var i=t.data;s(i,function(t,i){f.setAttrib(n,"data-"+i,t)})}})};t.addButton(i,{name:i,icon:i,iconset:"xenforo",type:"splitbutton",menu:[{value:"setProperties",text:"Quote properties"}],onshow:function(){n(".mce-tooltip:visible").hide();var i=u();this.menu._items.disabled(!i)},onselect:function(n){var h=n.control,s=n.control._value,i=u(),r=t.dom,f=r.getAttribs(i),o=r.getAttrib(i,"data-username");s=="setProperties"&&e(i,o,f,r)},onclick:function(){var i,f,e;if(t.execCommand("mceBlockQuote"),i=u(),f=t.dom,i==r)return!1;e=f.getAttribs(i,"data-mcequote"),e.length||f.setAttribs(i,{"class":"mce_quote","data-mcequote":"true"})},onPostRender:function(){var i=this;if(t.formatter)t.formatter.formatChanged("blockquote",function(n){i.active(n)});else t.on("init",function(){t.formatter.formatChanged("blockquote",function(n){i.active(n)})})}})})})(jQuery,this,document);