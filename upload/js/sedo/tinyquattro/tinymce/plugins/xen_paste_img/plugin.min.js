tinymce.create("tinymce.plugins.xen_paste_img",{init:function(n){this.editor=n;var t=this;n.on("PastePreProcess",function(i){var o,e,s,f,h;if(t.$textarea=$(n.getElement()),t.$container=$(n.getContainer()),t.$editor=$(n.getBody()),o=i.content,o.match(/^<img[^>]+?src="data:[^>]+;base64,[^>]+?>$/i)){try{e=$(o)}catch(i){return}if(s=e.prop("tagName"),s&&s.toLowerCase()=="img"){var u=e.attr("src"),c=/^data:image\/([a-z0-9_-]+);([a-z0-9_-]+),([\W\w]+)$/i,r=u.match(c);u&&r&&(f=t.$editor.find("img[data-paste-id]").length,h=n.dom.create("img",{"data-paste-id":f,src:u,style:"-x-ignore: 1"}),i.content="",n.selection.setNode(h),t.uploadPastedImage(f,r[1],r[3],r[2]))}}})},uploadPastedImage:function(n,t,i,r){var f,o,h,e,u,s,c;if($uploader=this.$container.closest("form").find(".AttachmentUploader"),$textarea=this.$textarea,$editor=this.$editor,!$uploader.length)return!1;try{if(f=new FormData,typeof i=="string"){for(o=r=="base64"?atob(i):unescape(i),h=[],e=0;e<o.length;e++)h.push(o.charCodeAt(e));i=new Blob([new Uint8Array(h)],{type:"image/"+t})}u=new Date,s="upload_"+u.getFullYear()+"-"+(u.getMonth()+1)+"-"+u.getDate()+"_"+u.getHours()+"-"+u.getMinutes()+"-"+u.getSeconds()+"."+t,f.append("upload",i,s),f.append("filename",s),f.append("_xfToken",XenForo._csrfToken),f.append("_xfNoRedirect","1"),$uploader.find(".HiddenInput").each(function(){var n=$(this);f.append(n.data("name"),n.data("value"))})}catch(l){return!1}return c=this,$.ajax({url:XenForo.canonicalizeUrl($uploader.data("action"),XenForo.ajaxBaseHref),method:"POST",dataType:"json",data:f,processData:!1,contentType:!1}).done(function(t){c.$textarea.data("mce4")&&($img=$editor.find("img[data-paste-id="+n+"]"),XenForo.hasResponseError(t)?$img.remove():($img.data("paste-id","").attr("src",t.viewUrl).attr("alt","attachFull"+t.attachment_id).addClass("attachFull"),$uploader.trigger({type:"AttachmentUploaded",ajaxData:t})))}).fail(function(t){$editor.find("img[data-paste-id="+n+"]").remove();try{var i=$.parseJSON(t.responseText);i&&XenForo.hasResponseError(i)}catch(r){}}),!0}}),tinymce.PluginManager.add("xen_paste_img",tinymce.plugins.xen_paste_img);